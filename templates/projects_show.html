{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="row" style="justify-content:space-between; align-items:flex-start;">
    <div>
      <h3 style="margin:0;">{{ project.title }}</h3>
      {% if project.description %}<div class="muted markdown-block" style="margin:6px 0;" data-markdown-project>{{ project.description }}</div>{% endif %}
      <p class="muted" style="margin:6px 0;">Project code: <code>{{ project.code }}</code></p>
      <p class="muted" style="margin:6px 0;">
        {% if project.required_task_count %}
          Requires {{ project.required_task_count }} task(s) to finish.
        {% else %}
          All tasks must be completed.
        {% endif %}
      </p>
      {% if project.instructions %}
        <div style="margin-top:10px; padding:10px; border:1px dashed #334155; border-radius:10px;">
          <strong>Student instructions</strong>
          <div class="muted markdown-block" style="margin:6px 0 0 0;" data-markdown-project>{{ project.instructions }}</div>
        </div>
      {% endif %}
    </div>
    <div class="row" style="gap:8px;">
      <a class="btn" href="{{ url_for('projects_edit', code=project.code) }}">Edit details</a>
      <form method="post" action="{{ url_for('projects_publish', code=project.code) }}">
        <input type="hidden" name="csrf" value="{{ csrf_token() }}">
        <input type="hidden" name="state" value="{{ 'unpublish' if project.is_active else 'publish' }}">
        <button class="btn {% if not project.is_active %}btn-primary{% endif %}" type="submit">
          {{ "Unpublish" if project.is_active else "Publish project" }}
        </button>
      </form>
      <a class="btn" href="{{ url_for('projects_submissions_overview', code=project.code) }}">Student attempts</a>
      <a class="btn" href="{{ url_for('projects_list') }}">Back to list</a>
    </div>
  </div>
  <p class="muted" style="margin-top:8px;">
    Status:
    {% if project.is_active %}
      <span style="color:#4ade80;">Published</span>
    {% else %}
      <span style="color:#f87171;">Draft (hidden from students)</span>
    {% endif %}
  </p>
  <p class="muted" style="margin-top:4px;">Points: <strong>{{ project.points }}</strong> • Retry cooldown: <strong>{{ project.retry_cooldown_minutes }} min</strong></p>
</div>

{% if status_message %}
  <div class="sp"></div>
  <div class="card" style="border-color:#334155; background:#0b1220;">
    <p class="muted" style="margin:0;">{{ status_message }}</p>
  </div>
{% endif %}

<div class="sp"></div>

<div class="card">
  <h3 style="margin:0;">Project meta</h3>
  <p class="muted" style="margin-top:6px;">Update points and retry cooldown. Points are awarded once when a student completes the project; cooldown delays retries after rejection.</p>
  <form method="post" action="{{ url_for('projects_update_meta', code=project.code) }}" style="margin-top:10px; display:grid; gap:10px;">
    <input type="hidden" name="csrf" value="{{ csrf_token() }}">
    <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap;">
      <label style="min-width:140px;">Points</label>
      <input type="number" min="0" name="points" value="{{ project.points }}" style="flex:1; min-width:160px;">
    </div>
    <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap;">
      <label style="min-width:140px;">Retry cooldown (minutes)</label>
      <input type="number" min="0" name="retry_cooldown_minutes" value="{{ project.retry_cooldown_minutes }}" style="flex:1; min-width:160px;">
    </div>
    <div>
      <button class="btn btn-primary" type="submit">Save</button>
    </div>
  </form>
  <div class="sp"></div>
  <div style="padding:10px; border:1px dashed #334155; border-radius:10px;">
    <strong>Recalculate project points</strong>
    <p class="muted" style="margin:6px 0 0 0;">Remove previous project grade entries and re-award points for students who have accepted submissions.</p>
    <form method="post" action="{{ url_for('projects_recalculate_points', code=project.code) }}" style="margin-top:10px;" onsubmit="return confirm('Remove previous project points and re-award based on current points?');">
      <input type="hidden" name="csrf" value="{{ csrf_token() }}">
      <button class="btn" type="submit">Recalculate points</button>
    </form>
  </div>
</div>

<div class="sp"></div>

<div class="card">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">Dependencies</h3>
  </div>
  {% if dependencies %}
    <ul style="margin:10px 0 0 16px;">
      {% for dep in dependencies %}
        <li>{{ dep.prerequisite.title }} ({{ dep.prerequisite.code }})</li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted" style="margin-top:6px;">No prerequisites.</p>
  {% endif %}
  {% if other_projects %}
    <form method="post" action="{{ url_for('projects_add_dependency', code=project.code) }}" style="margin-top:12px;">
      <input type="hidden" name="csrf" value="{{ csrf_token() }}">
      <label>Add prerequisite</label>
      <div class="row" style="gap:10px;">
        <select name="dependency_code" style="flex:1;">
          {% for p in other_projects %}
            <option value="{{ p.code }}">{{ p.title }} ({{ p.code }})</option>
          {% endfor %}
        </select>
        <button class="btn" type="submit">Add</button>
      </div>
    </form>
  {% endif %}
</div>

<div class="sp"></div>

<div class="card">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">Group assignments</h3>
  </div>
  {% if group_assignments %}
    <table style="margin-top:12px;">
      <thead>
        <tr>
          <th>Audience</th>
          <th>Requirement</th>
          <th>Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for assignment in group_assignments %}
        <tr>
          <td>
            {% if assignment.applies_to_all %}
              All students (cohort)
            {% elif assignment.group %}
              {{ assignment.group.name }}
            {% else %}
              (deleted group)
            {% endif %}
          </td>
          <td>{{ "Required" if assignment.is_required else "Optional" }}</td>
          <td>{{ assignment.created_at.strftime("%b %d %H:%M") if assignment.created_at else "—" }}</td>
          <td style="text-align:right;">
            <form method="post" action="{{ url_for('projects_remove_group_assignment', code=project.code, assignment_id=assignment.id) }}">
              <input type="hidden" name="csrf" value="{{ csrf_token() }}">
              <button class="btn" type="submit">Remove</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted" style="margin-top:6px;">No group targeting configured. Project is visible to everyone.</p>
  {% endif %}
  <form method="post" action="{{ url_for('projects_assign_group', code=project.code) }}" style="margin-top:12px;">
    <input type="hidden" name="csrf" value="{{ csrf_token() }}">
    <label>Assign to group or cohort</label>
    <div class="row" style="gap:10px;">
      <select name="group_scope" style="flex:1;">
        <option value="all">All students (cohort)</option>
        {% for g in student_groups %}
          <option value="{{ g.id }}">{{ g.name }}</option>
        {% endfor %}
      </select>
      <select name="is_required">
        <option value="1">Required</option>
        <option value="0">Optional</option>
      </select>
      <button class="btn" type="submit">Assign</button>
    </div>
  </form>
  <p class="muted" style="margin-top:8px; font-size:0.9rem;">If no assignments exist, the project stays visible to every student.</p>
</div>

<div class="sp"></div>

<div class="card">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">Tasks</h3>
    <div class="row" style="gap:8px;">
      <a class="btn" href="{{ url_for('projects_task_import', code=project.code) }}">Import tasks</a>
      <a class="btn btn-primary" href="{{ url_for('projects_task_new', code=project.code) }}">Add task</a>
    </div>
  </div>
  {% if tasks %}
    <table style="margin-top:12px;">
      <thead>
        <tr>
          <th style="width:50px;">Order</th>
          <th>Title</th>
          <th>Required</th>
          <th>Auto grade</th>
          <th>Mentor review</th>
          <th>Created</th>
          <th style="width:220px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for task in tasks %}
        <tr>
          <td>
            <div class="row" style="gap:4px;">
              <form method="post" action="{{ url_for('projects_task_move', code=project.code, task_id=task.id) }}" style="display:inline;">
                <input type="hidden" name="csrf" value="{{ csrf_token() }}">
                <input type="hidden" name="direction" value="up">
                <button class="btn" type="submit" style="padding:4px 8px; font-size:0.85rem;" {% if loop.first %}disabled{% endif %} title="Move up">↑</button>
              </form>
              <form method="post" action="{{ url_for('projects_task_move', code=project.code, task_id=task.id) }}" style="display:inline;">
                <input type="hidden" name="csrf" value="{{ csrf_token() }}">
                <input type="hidden" name="direction" value="down">
                <button class="btn" type="submit" style="padding:4px 8px; font-size:0.85rem;" {% if loop.last %}disabled{% endif %} title="Move down">↓</button>
              </form>
            </div>
          </td>
          <td>{{ task.title }}</td>
          <td>{{ "Yes" if task.required else "Optional" }}</td>
          <td>{{ "Yes" if task.auto_grade else "No" }}</td>
          <td>{{ "Yes" if task.requires_review else "No" }}</td>
          <td>{{ task.created_at.strftime("%b %d %H:%M") if task.created_at else "—" }}</td>
          <td>
            <div class="row" style="gap:6px;">
              <a class="btn" href="{{ url_for('projects_task_edit', code=project.code, task_id=task.id) }}">Edit</a>
              <form method="post" action="{{ url_for('projects_task_delete', code=project.code, task_id=task.id) }}" onsubmit="return confirm('Delete this task?');">
                <input type="hidden" name="csrf" value="{{ csrf_token() }}">
                <button class="btn btn-danger" type="submit">Delete</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted" style="margin-top:12px;">No tasks yet.</p>
  {% endif %}
</div>
{% endblock %}
{% block scripts %}
<script>
(function(){
  const blocks = document.querySelectorAll("[data-markdown-project]");
  if (!blocks.length) return;
  const escapeHtml = (str) => (str || "").replace(/[&<>"']/g, (ch) => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[ch] || ch));
  const inline = (text) => escapeHtml(text || "").replace(/`([^`]+)`/g, "<code>$1</code>").replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>").replace(/\*([^*]+)\*/g, "<em>$1</em>");
  const render = (text) => {
    const lines = (text || "").split(/\n/);
    const parts = [];
    let inList = false;
    lines.forEach((line) => {
      const m = line.match(/^\s*-\s+(.*)/);
      if (m) {
        if (!inList) { parts.push("<ul style='margin:6px 0 6px 18px; padding:0;'>"); inList = true; }
        parts.push(`<li style="margin:2px 0;">${inline(m[1])}</li>`);
      } else {
        if (inList) { parts.push("</ul>"); inList = false; }
        if (!line.trim()) { parts.push("<br>"); }
        else { parts.push(`<p style="margin:4px 0;">${inline(line)}</p>`); }
      }
    });
    if (inList) parts.push("</ul>");
    return parts.join("");
  };
  blocks.forEach((el) => { el.innerHTML = render(el.textContent || ""); el.style.whiteSpace = "normal"; });
})();
</script>
{% endblock %}

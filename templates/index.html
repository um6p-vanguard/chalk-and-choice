{% extends "base.html" %}
{% block content %}

<style>
  /* ---- Unified section card styles ---- */
  .sec-card {
    max-width: 820px;
    margin: 0 auto 16px auto;
    padding: 16px 18px;
    border-radius: 12px;
    background: #0f1720;
    border: 1px solid rgba(255,255,255,.06);
    box-shadow: 0 6px 24px rgba(0,0,0,.35);
  }
  .sec-title { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: .2px; }
  .sec-hint  { color: #9bb2c4; margin: 6px 0 12px 0; }

  .list { display: flex; flex-direction: column; gap: 10px; margin: 8px 0 0 0; padding: 0; }
  .item-row {
    display: flex; gap: 12px; align-items: center; justify-content: space-between;
    background: #091d29; border: 1px solid rgba(255,255,255,.06); border-radius: 10px; padding: 10px 12px;
  }
  .item-main { min-width: 0; }
  .item-title { margin: 0; font-weight: 600; color: #e6f2f8; }
  .item-desc  { color: #9bb2c4; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 520px; }
  .item-meta  { color: #9ecbff; font-size: 13px; margin-top: 4px; }
  .item-actions { display: flex; gap: 8px; flex-wrap: wrap; }

  .pill-due {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 2px 8px; border-radius: 999px; font-size: 12px;
    background: rgba(122,195,255,.12); color: #9ecbff; border: 1px solid rgba(122,195,255,.25);
  }
  .btn-cta {
    background: linear-gradient(180deg,#3aa0ff,#1f7bd6); color: #fff; border: none;
    padding: 8px 12px; border-radius: 10px; font-weight: 600; text-decoration: none; display:inline-block;
  }
  .btn-ghost {
    background: #0b2b3a; color: #cfe7f5; border: 1px solid rgba(255,255,255,.08);
    padding: 8px 12px; border-radius: 10px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-ok       { border: 1px solid rgba(22,163,74,.55); }
  .btn-confused { border: 1px solid rgba(239,68,68,.55); }

  .q-form {
    margin-top: 10px; display: none;
    background: #091d29; border: 1px solid rgba(255,255,255,.06);
    border-radius: 10px; padding: 10px 12px;
  }
  .q-form label { display:block; margin-bottom: 6px; color: #cde1ee; font-weight: 600; }
  .q-input {
    width:100%; padding:10px; border-radius:8px; border:1px solid #334155;
    background:#0b1220; color:var(--text);
  }
  .q-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }
  .status-line { color:#9bb2c4; margin-top:10px; display:none; }
  .status-line.show { display:block; }
</style>

{# ------------------------------------------------------------------------
   CASE 1: STUDENT is signed in  -> show Homework + Live Feedback
   We expect the view to pass: student_name, active_homeworks, user=None
------------------------------------------------------------------------- #}
{% if student_name and not user %}

  {% if active_homeworks and active_homeworks|length %}
  <div class="sec-card">
    <h3 class="sec-title">Assigned Homework</h3>
    <p class="sec-hint">Open, work, and submit before the due date.</p>

    <div class="list">
      {% for hw in active_homeworks %}
      <div class="item-row">
        <div class="item-main">
          <div class="item-title">{{ hw.title }}</div>
          {% if hw.description %}
            <div class="item-desc">{{ hw.description }}</div>
          {% endif %}
          <div class="item-meta">
            {% if hw.due_at %}
              <span class="pill-due">
                Due <time class="due-abs" datetime="{{ hw.due_at.isoformat() }}">{{ hw.due_at }}</time>
                <span>‚Ä¢</span>
                <span class="due-rel" data-due="{{ hw.due_at.isoformat() }}">calculating‚Ä¶</span>
              </span>
            {% else %}
              <span class="pill-due">No due date</span>
            {% endif %}
          </div>
        </div>
        <div class="item-actions">
          <a class="btn-cta" href="{{ url_for('homework_open', code=hw.code) }}">{{ 'Resume' if hw.has_copy else 'Start' }}</a>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% if available_exercises and available_exercises|length %}
  <div class="sec-card">
    <h3 class="sec-title">üìù Available Coding Exercise Sets</h3>
    <p class="sec-hint">Practice your coding skills with these exercise sets.</p>

    <div class="list">
      {% for ex in available_exercises %}
      <div class="item-row">
        <div class="item-main">
          <div class="item-title">{{ ex.title }}</div>
          <div class="item-desc">
            {% if ex.description %}
              {{ ex.description[:100] }}{% if ex.description|length > 100 %}...{% endif %}
            {% else %}
              Complete {{ ex.exercise_count }} coding exercise{{ 's' if ex.exercise_count != 1 else '' }}
            {% endif %}
          </div>
          <div class="item-meta">
            <span style="color: #60a5fa;">
              {{ ex.exercise_count }} exercise{{ 's' if ex.exercise_count != 1 else '' }}
            </span>
            ‚Ä¢ {{ ex.total_points }} total points
            {% if ex.completed_count > 0 %}
              ‚Ä¢ <span style="color: #10b981;">{{ ex.completed_count }}/{{ ex.exercise_count }} completed</span>
            {% endif %}
          </div>
        </div>
        <div class="item-actions">
          <a class="btn-cta" href="{{ url_for('exercise_play', code=ex.code) }}">
            {% if ex.is_completed %}
              ‚úì Review
            {% elif ex.completed_count > 0 %}
              Continue
            {% else %}
              Start
            {% endif %}
          </a>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <div style="text-align: center; margin-top: 16px;">
      <a href="{{ url_for('exercises_list') }}" class="btn-ghost">View All Exercise Sets ‚Üí</a>
    </div>
  </div>
  {% endif %}

  <div class="sec-card">
    <h3 class="sec-title">üìÖ Mentor Sessions</h3>
    <p class="sec-hint">Book one-on-one time with mentors for help and guidance.</p>

    <div class="item-row">
      <div class="item-main">
        <div class="item-title">Book a Mentor Session</div>
        <div class="item-desc">View available time slots and schedule sessions with mentors</div>
      </div>
      <div class="item-actions">
        <a class="btn-cta" href="{{ url_for('student_slots') }}">Browse & Book Sessions</a>
      </div>
    </div>
  </div>

  <div class="sec-card">
    <h3 class="sec-title">Live Lecture Feedback</h3>
    <p class="sec-hint">Signed in as <strong>{{ student_name }}</strong>. Let your instructor know how you're doing.</p>

    <div class="item-row">
      <div class="item-main">
        <div class="item-title">Quick reactions</div>
        <div class="item-desc">Send a lightweight signal during the lecture.</div>
      </div>
      <div class="item-actions">
        <button id="btn-ok" class="btn-ghost btn-ok">All good</button>
        <button id="btn-confused" class="btn-ghost btn-confused">I‚Äôm confused</button>
        <button id="btn-question" class="btn-cta">Ask a question</button>
      </div>
    </div>

    <form id="q-form" class="q-form">
      <label for="q-text">Your question</label>
      <textarea id="q-text" rows="4" class="q-input" placeholder="Type your question..."></textarea>
      <div class="q-actions">
        <button type="button" class="btn-ghost" id="q-cancel">Cancel</button>
        <button type="submit" class="btn-cta">Send</button>
      </div>
    </form>

    <p id="notice" class="status-line"></p>
  </div>

{# ------------------------------------------------------------------------
   CASE 2: INSTRUCTOR / ADMIN is signed in -> no login button
   We expect the view to pass: user=current_user(), no student_name
------------------------------------------------------------------------- #}
{% elif user %}
  <div class="sec-card">
    <h3 class="sec-title">Welcome, {{ user.name or 'Instructor' }}</h3>
    <p class="sec-hint">Use the navigation to manage polls, signals, homework, and coding exercises.</p>
    <div class="item-row" style="justify-content:flex-start;">
      <div class="item-actions">
        <a class="btn-cta" href="{{ url_for('homework_list') }}">Homework Submissions</a>
        <a class="btn-ghost" href="{{ url_for('homework_new') }}">Create Homework</a>
        <a class="btn-ghost" href="{{ url_for('signals_dashboard') }}">Live Signals</a>
      </div>
    </div>
    <div class="item-row" style="justify-content:flex-start; margin-top: 10px;">
      <div class="item-actions">
        <a class="btn-cta" style="background: linear-gradient(180deg,#10b981,#059669);" href="{{ url_for('exercise_new') }}">Create Exercises</a>
        <a class="btn-ghost" href="{{ url_for('exercises_manage') }}">Manage Exercises</a>
        <a class="btn-ghost" href="{{ url_for('exercises_list') }}">Browse Exercises</a>
      </div>
    </div>
    {% if user.role == 'mentor' %}
    <div class="item-row" style="justify-content:flex-start; margin-top: 10px;">
      <div class="item-actions">
        <a class="btn-cta" style="background: linear-gradient(180deg,#637FBE,#5775B8);" href="{{ url_for('mentor_slots') }}">üìÖ My Availability Slots</a>
        <a class="btn-ghost" href="{{ url_for('mentor_slot_new') }}">+ Create New Slot</a>
      </div>
    </div>
    {% elif user.role in ['admin', 'instructor'] %}
    <div class="item-row" style="justify-content:flex-start; margin-top: 10px;">
      <div class="item-actions">
        <a class="btn-cta" style="background: linear-gradient(180deg,#637FBE,#5775B8);" href="{{ url_for('admin_mentor_slots') }}">üìä Mentor Slots Overview</a>
        <a class="btn-ghost" href="{{ url_for('mentors_list') }}">Manage Mentors</a>
      </div>
    </div>
    {% endif %}
  </div>

{# ------------------------------------------------------------------------
   CASE 3: ANONYMOUS visitor -> show a clear, working Login CTA
------------------------------------------------------------------------- #}
{% else %}
  <div class="sec-card" role="region" aria-label="Login">
    <h3 class="sec-title">Welcome</h3>
    <p class="sec-hint">Log in to participate.</p>
    <a class="btn-cta" href="{{ url_for('login') }}" id="home-login-btn">Login</a>
  </div>
{% endif %}

<script>
(function(){
  // ---- Relative "due in" display ----
  function relTime(targetISO){
    const target = new Date(targetISO);
    const now = new Date();
    const ms = target - now;
    if (isNaN(ms)) return '';
    const sec = Math.round(ms / 1000);
    const abs = Math.abs(sec);
    const sign = sec >= 0 ? 1 : -1;

    const mins = Math.round(abs / 60);
    const hours = Math.round(abs / 3600);
    const days = Math.round(abs / 86400);

    if (abs < 60) return sign > 0 ? 'in seconds' : 'seconds ago';
    if (abs < 3600) return sign > 0 ? `in ${mins} min` : `${mins} min ago`;
    if (abs < 86400) return sign > 0 ? `in ${hours} h` : `${hours} h ago`;
    return sign > 0 ? `in ${days} d` : `${days} d ago`;
  }
  function updateDue() {
    document.querySelectorAll('.due-rel').forEach(el => {
      const iso = el.getAttribute('data-due');
      if (!iso) return;
      el.textContent = relTime(iso);
    });
  }
  updateDue();
  setInterval(updateDue, 60 * 1000);

  // ---- Feedback JS (student case only) ----
  const csrf = "{{ csrf_token() }}";
  const notice = document.getElementById("notice");
  function say(msg){
    if (!notice) return;
    notice.textContent = msg;
    notice.classList.add('show');
  }
  function clearMsg(){
    if (!notice) return;
    notice.classList.remove('show');
    notice.textContent = "";
  }

  async function postJSON(url, data){
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json", "X-CSRF": csrf },
      body: JSON.stringify(data),
      credentials: "same-origin"
    });
    return res;
  }

  const okBtn   = document.getElementById("btn-ok");
  const confBtn = document.getElementById("btn-confused");
  const qBtn    = document.getElementById("btn-question");
  const qForm   = document.getElementById("q-form");
  const qText   = document.getElementById("q-text");
  const qCancel = document.getElementById("q-cancel");

  let cooling = false;
  async function sendSignal(kind){
    if (cooling) return;
    cooling = true;
    clearMsg();
    try{
      const res = await postJSON("{{ url_for('signal_post') }}", { kind });
      if (res.ok) say(kind === "ok" ? "Got it ‚Äî thanks." : "Noted. We‚Äôll slow down.");
      else say("Couldn‚Äôt send feedback (try again).");
    }catch(e){ say("Network error. Try again."); }
    setTimeout(()=> cooling=false, 3000);
  }

  okBtn?.addEventListener("click", () => sendSignal("ok"));
  confBtn?.addEventListener("click", () => sendSignal("confused"));
  qBtn?.addEventListener("click", () => {
    if (!qForm) return;
    qForm.style.display = "block";
    qText?.focus();
  });
  qCancel?.addEventListener("click", () => {
    if (!qForm) return;
    qForm.style.display = "none";
    if (qText) qText.value = "";
    clearMsg();
  });

  qForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = (qText?.value || "").trim();
    if (!text){ say("Please type a question first."); return; }
    try{
      const res = await postJSON("{{ url_for('question_post') }}", { text });
      if (res.ok){
        say("Question sent.");
        if (qText) qText.value = "";
        if (qForm) qForm.style.display = "none";
      }else if(res.status === 429){
        say("You‚Äôve asked recently. Please wait a moment.");
      }else{
        say("Couldn‚Äôt send your question. Try again.");
      }
    }catch(e){ say("Network error. Try again."); }
  });
})();
</script>
{% endblock %}

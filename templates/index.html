{% extends "base.html" %}
{% block content %}
{% if student_name and not user %}
<div class="card" style="max-width:820px;">
  <h3 style="margin-top:0;">Live Lecture Feedback</h3>
  <p class="muted" style="margin-top:-6px;">Signed in as <strong>{{ student_name }}</strong></p>

  <div class="row" style="gap:10px; margin:12px 0 18px;">
    <button id="btn-ok" class="btn" style="border-color:#16a34a;">All good</button>
    <button id="btn-confused" class="btn" style="border-color:#ef4444;">I’m confused</button>
    <button id="btn-question" class="btn">Ask a question</button>
  </div>

  <form id="q-form" style="display:none; margin-top:6px;">
    <label for="q-text">Your question</label>
    <textarea id="q-text" rows="4" style="width:100%; padding:10px; border-radius:8px; border:1px solid #334155; background:#0b1220; color:var(--text);" placeholder="Type your question..."></textarea>
    <div class="row" style="justify-content:flex-end; gap:8px; margin-top:8px;">
      <button type="button" class="btn" id="q-cancel">Cancel</button>
      <button type="submit" class="btn btn-primary">Send</button>
    </div>
  </form>

  <p id="notice" class="muted" style="display:none; margin-top:12px;"></p>
</div>
{% else %}
<div class="card">
  <h3>Welcome</h3>
  <p class="muted">Log in to participate.</p>
  <a class="btn" href="{{ url_for('login') }}">Login</a>
</div>
{% endif %}

<script>
(function(){
  const csrf = "{{ csrf_token() }}";
  const notice = document.getElementById("notice");
  function say(msg){ notice.textContent = msg; notice.style.display = "block"; }
  function clearMsg(){ notice.style.display = "none"; notice.textContent = ""; }

  async function postJSON(url, data){
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json", "X-CSRF": csrf },
      body: JSON.stringify(data),
      credentials: "same-origin"
    });
    return res;
  }

  // Quick signals
  const okBtn = document.getElementById("btn-ok");
  const confBtn = document.getElementById("btn-confused");
  const qBtn = document.getElementById("btn-question");
  const qForm = document.getElementById("q-form");
  const qText = document.getElementById("q-text");
  const qCancel = document.getElementById("q-cancel");

  let cooling = false;
  async function sendSignal(kind){
    if (cooling) return;
    cooling = true;
    clearMsg();
    try{
      const res = await postJSON("{{ url_for('signal_post') }}", { kind });
      if (res.ok) say(kind === "ok" ? "Got it — thanks." : "Noted. We’ll slow down.");
      else say("Couldn’t send feedback (try again).");
    }catch(e){ say("Network error. Try again."); }
    setTimeout(()=> cooling=false, 3000); // 3s cooldown
  }

  okBtn?.addEventListener("click", () => sendSignal("ok"));
  confBtn?.addEventListener("click", () => sendSignal("confused"));

  // Ask a question
  qBtn?.addEventListener("click", () => { qForm.style.display = "block"; qText.focus(); });
  qCancel?.addEventListener("click", () => { qForm.style.display = "none"; qText.value = ""; clearMsg(); });

  qForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = (qText.value || "").trim();
    if (!text){ say("Please type a question first."); return; }
    try{
      const res = await postJSON("{{ url_for('question_post') }}", { text });
      if (res.ok){
        say("Question sent.");
        qText.value = ""; qForm.style.display = "none";
      }else if(res.status === 429){
        say("You’ve asked recently. Please wait a moment.");
      }else{
        say("Couldn’t send your question. Try again.");
      }
    }catch(e){ say("Network error. Try again."); }
  });
})();
</script>
{% endblock %}

{% macro render(questions, answers, logs_by_question=None, grading_by_question=None, show_meta=False, task_auto_grade=True, code_runs_enabled=True, submission_id=None, attempt_id=None) %}
  {% set logs_by_question = logs_by_question or {} %}
  {% set grading_by_question = grading_by_question or {} %}
  {% if not questions %}
    <p class="muted" style="margin:0;">No questions found for this task.</p>
  {% else %}
  <div style="display:flex; flex-direction:column; gap:14px;">
    {% for q in questions %}
      {% set qid = (q.id|string) if q.id is defined else (q.get("id")|string) %}
      {% set answer = answers.get(qid) if answers else "" %}
      {% set answer_val = "" if answer is none else (answer|string) %}
      {% set qtype = q.type or q.get("type") %}
      {% set qlogs = logs_by_question.get(qid, []) %}
      {% set grading = grading_by_question.get(qid) if grading_by_question else None %}
      {% set q_samples = q.samples if q.samples is defined else q.get("samples") %}
      {% set has_samples = q_samples and (q_samples|length > 0) %}
      {% set auto_status = "Manual review" %}
      {% set auto_color = "#f59e0b" %}
      {% if not task_auto_grade %}
        {% set auto_status = "Auto-grade off" %}
        {% set auto_color = "#94a3b8" %}
      {% elif qtype in ("mcq", "multi", "tokens", "fill") %}
        {% set auto_status = "Auto-graded" %}
        {% set auto_color = "#10b981" %}
      {% elif qtype == "code" and has_samples %}
        {% set auto_status = "Auto-graded" %}
        {% set auto_color = "#10b981" %}
      {% endif %}
      <div style="border:1px solid #1f2937; border-radius:12px; padding:14px; background:#0b1220;">
        <div class="row" style="justify-content:space-between; align-items:flex-start; gap:10px;">
          <div style="flex:1;">
            <div class="muted" style="font-size:0.9rem;">Question {{ loop.index }}{% if q.title %} • <span>{{ q.title|markdown_inline }}</span>{% endif %}</div>
            {% if q.prompt %}<div class="markdown-block" style="margin:6px 0 0 0;">{{ q.prompt|markdown }}</div>{% endif %}
          </div>
          <div class="row" style="gap:6px; flex-wrap:wrap; justify-content:flex-end;">
            {% if show_meta %}
              <span style="font-size:0.8rem; padding:4px 10px; border-radius:20px; border:1px solid {{ auto_color }}; color:{{ auto_color }}; background:#0b1220; white-space:nowrap;">{{ auto_status }}</span>
            {% endif %}
            <span style="font-size:0.85rem; padding:4px 10px; border-radius:20px; background:#1f2937; border:1px solid #334155; white-space:nowrap;">{{ qtype|capitalize }}</span>
          </div>
        </div>
        {% if q.code_snippet %}
          <pre style="margin-top:10px; white-space:pre-wrap; background:#0f172a; padding:10px; border-radius:10px; border:1px solid #1f2937;">{{ q.code_snippet }}</pre>
        {% endif %}
        {% if qtype == "code" %}
          {% if q.statement %}
            <div style="margin-top:10px; padding:10px; border-radius:10px; border:1px dashed #334155;">
              <strong>Problem statement</strong>
              <div class="markdown-block muted" style="margin:6px 0 0 0;">{{ q.statement|markdown }}</div>
            </div>
          {% endif %}
          {% if q.mode == "function" and q.function_signature %}
            <div style="margin-top:10px; padding:10px; border-radius:10px; border:1px solid #1f2937; background:#0f172a;">
              <div class="muted">Signature</div>
              <pre style="margin:6px 0 0 0; background:#0b1220; padding:8px; border-radius:8px; border:1px solid #1f2937;">{{ q.function_signature }}</pre>
            </div>
          {% endif %}
        {% endif %}
        <div style="margin-top:12px; padding:12px; border-radius:10px; border:1px solid #334155; background:#0f172a;">
          <div class="muted" style="font-size:0.9rem;">Student answer</div>
          {% if qtype in ("mcq", "multi") %}
            {% set selected_raw = answer_val %}
            {% if qtype == "multi" %}
              {% set selected = selected_raw.split("||") if selected_raw else [] %}
            {% else %}
              {% set selected = [selected_raw] if selected_raw not in (None, "") else [] %}
            {% endif %}
            {% set options = q.options or [] %}
            {% if options %}
              <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:8px;">
                {% for opt in options %}
                  {% set idx = loop.index0|string %}
                  {% set chosen = idx in selected %}
                  <div style="border:1px solid {{ '#38bdf8' if chosen else '#1f2937' }}; border-radius:10px; padding:10px; background:{{ '#0b1530' if chosen else '#0b1220' }};">
                    <div class="muted" style="font-size:0.85rem;">Option {{ loop.index }}</div>
                    <div class="markdown-block" style="margin-top:6px;">{{ opt|markdown }}</div>
                    {% if chosen %}
                      <span style="display:inline-block; margin-top:8px; font-size:0.8rem; padding:4px 8px; border-radius:14px; background:#0ea5e9; color:#0b1220;">Selected</span>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
              {% if not selected %}
                <p class="muted" style="margin-top:8px;">No choice selected.</p>
              {% endif %}
            {% else %}
              <p class="muted" style="margin-top:8px;">No options configured.</p>
            {% endif %}
          {% elif qtype == "text" %}
            <pre style="margin-top:6px; white-space:pre-wrap; background:#0b1220; padding:10px; border-radius:10px; border:1px solid #1f2937;">{{ answer_val or "—" }}</pre>
          {% elif qtype == "code" %}
            <pre style="margin-top:6px; white-space:pre-wrap; background:#0b1220; padding:10px; border-radius:10px; border:1px solid #1f2937;">{{ answer_val or "# no submission" }}</pre>
          {% elif qtype == "file" %}
            {% set file_info = answer if answer is mapping else None %}
            {% if file_info %}
              <div style="margin-top:6px; display:flex; flex-direction:column; gap:6px;">
                <div><strong>{{ file_info.original_name or file_info.stored_name or "uploaded.zip" }}</strong></div>
                {% if file_info.size %}
                  <div class="muted" style="font-size:0.9rem;">Size: {{ (file_info.size // 1024) }} KB</div>
                {% endif %}
                {% if file_info.uploaded_at %}
                  <div class="muted" style="font-size:0.9rem;">Uploaded: {{ file_info.uploaded_at }}</div>
                {% endif %}
                {% if submission_id %}
                  <a class="btn" href="{{ url_for('project_task_file_download', submission_id=submission_id, question_id=qid, attempt_id=attempt_id) }}">Download file</a>
                {% endif %}
              </div>
            {% else %}
              <p class="muted" style="margin-top:6px;">No file uploaded.</p>
            {% endif %}
          {% elif qtype == "tokens" %}
            {% set tpl = q.template or "" %}
            {% set segments = tpl.split("[[blank]]") %}
            {% set filled = answer_val.split("||") if answer_val else [] %}
            <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; align-items:center;">
              {% for segment in segments %}
                {% if segment %}<span>{{ segment|markdown_inline }}</span>{% endif %}
                {% if not loop.last %}
                  {% set val = filled[loop.index0] if loop.index0 < filled|length else "" %}
                  <span style="padding:6px 10px; border-radius:10px; background:#1f2937; border:1px solid #334155; min-width:80px; text-align:center;">{{ val or "—" }}</span>
                {% endif %}
              {% endfor %}
            </div>
          {% elif qtype == "fill" %}
            {% set tpl = q.template or "" %}
            {% set segments = tpl.split("[[blank]]") %}
            {% set filled = answer_val.split("||") if answer_val else [] %}
            <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; align-items:center;">
              {% for segment in segments %}
                {% if segment %}<span>{{ segment|markdown_inline }}</span>{% endif %}
                {% if not loop.last %}
                  {% set val = filled[loop.index0] if loop.index0 < filled|length else "" %}
                  <span style="padding:6px 10px; border-radius:10px; background:#1f2937; border:1px solid #334155; min-width:80px; text-align:center;">{{ val or "—" }}</span>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            <pre style="margin-top:6px; white-space:pre-wrap; background:#0b1220; padding:10px; border-radius:10px; border:1px solid #1f2937;">{{ answer_val or "—" }}</pre>
          {% endif %}
        </div>
        {% if show_meta %}
          <div style="margin-top:12px; padding:12px; border-radius:10px; border:1px dashed #334155; background:#0b1220;">
            <div class="muted" style="font-size:0.9rem;">Correct answer</div>
            {% if qtype in ("mcq", "multi") %}
              {% set correct_indices = q.correct_indices or [] %}
              {% set options = q.options or [] %}
              {% if correct_indices %}
                <ul style="margin:8px 0 0 16px; padding:0; list-style:square;">
                  {% for raw_idx in correct_indices %}
                    {% set idx = raw_idx|int %}
                    {% set opt = options[idx] if idx < (options|length) else "" %}
                    <li>
                      Option {{ idx + 1 }}
                      {% if opt %}- {{ opt|markdown_inline }}{% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="muted" style="margin:6px 0 0 0;">No correct option configured.</p>
              {% endif %}
            {% elif qtype == "tokens" %}
              {% set correct_tokens = q.correct_tokens or [] %}
              {% if correct_tokens %}
                <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
                  {% for tok in correct_tokens %}
                    <span style="padding:4px 8px; border-radius:10px; border:1px solid #334155; background:#0f172a;">{{ tok|markdown_inline }}</span>
                  {% endfor %}
                </div>
              {% else %}
                <p class="muted" style="margin:6px 0 0 0;">No correct tokens configured.</p>
              {% endif %}
            {% elif qtype == "fill" %}
              {% set answers_expected = q.answers or [] %}
              {% if answers_expected %}
                <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
                  {% for ans in answers_expected %}
                    <span style="padding:4px 8px; border-radius:10px; border:1px solid #334155; background:#0f172a;">{{ ans|markdown_inline }}</span>
                  {% endfor %}
                </div>
                {% if q.case_sensitive %}
                  <div class="muted" style="margin-top:6px; font-size:0.85rem;">Case-sensitive</div>
                {% endif %}
              {% else %}
                <p class="muted" style="margin:6px 0 0 0;">No correct answers configured.</p>
              {% endif %}
            {% elif qtype == "code" %}
              {% if has_samples %}
                <p class="muted" style="margin:6px 0 0 0;">Expected outputs are shown in the test results below.</p>
              {% else %}
                <p class="muted" style="margin:6px 0 0 0;">No tests configured for this code question.</p>
              {% endif %}
            {% elif qtype == "file" %}
              <p class="muted" style="margin:6px 0 0 0;">Upload a {{ q.accept or ".zip" }} file (max {{ q.max_mb or 5 }} MB).</p>
            {% else %}
              <p class="muted" style="margin:6px 0 0 0;">Manual review required.</p>
            {% endif %}
          </div>
        {% endif %}
        {% if show_meta and qtype == "code" %}
          <div style="margin-top:12px; padding:12px; border-radius:10px; border:1px solid #334155; background:#0f172a;">
            <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
              <strong>Code test results</strong>
              {% if grading and grading.timed_out %}
                <span style="font-size:0.85rem; padding:4px 10px; border-radius:20px; border:1px solid #f87171; color:#f87171;">Timed out</span>
              {% endif %}
            </div>
            {% if not code_runs_enabled %}
              <p class="muted" style="margin:8px 0 0 0;">Backend code runs are disabled.</p>
            {% elif not grading or not grading.cases %}
              <p class="muted" style="margin:8px 0 0 0;">No test runs available.</p>
            {% else %}
              {% set cases = grading.cases %}
              {% set visible_cases = cases | selectattr("hidden", "ne", True) | list %}
              {% set hidden_cases = cases | selectattr("hidden", "eq", True) | list %}
              {% set visible_passed = visible_cases | selectattr("status", "equalto", "passed") | list | length %}
              {% set hidden_passed = hidden_cases | selectattr("status", "equalto", "passed") | list | length %}
              <div class="muted" style="margin-top:8px; font-size:0.9rem;">
                Samples: {{ visible_passed }}/{{ visible_cases|length }} passed • Hidden: {{ hidden_passed }}/{{ hidden_cases|length }} passed
              </div>
              {% set input_label = "Call" if q.mode == "function" else "Input" %}
              {% if visible_cases %}
                <div style="margin-top:10px;">
                  <div class="muted" style="font-size:0.85rem;">Sample tests</div>
                  {% for case in visible_cases %}
                    {% set status = case.status or "unknown" %}
                    {% set status_color = "#38bdf8" %}
                    {% if status == "passed" %}
                      {% set status_color = "#4ade80" %}
                    {% elif status in ("mismatch", "timeout") %}
                      {% set status_color = "#fbbf24" %}
                    {% elif status == "error" %}
                      {% set status_color = "#f87171" %}
                    {% endif %}
                    <div style="margin-top:8px; padding:10px; border-radius:10px; border:1px solid #1f2937; background:#0b1220;">
                      <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
                        <strong>{{ case.name or "Sample" }}</strong>
                        <span style="font-size:0.85rem; padding:4px 10px; border-radius:20px; border:1px solid {{ status_color }}; color:{{ status_color }};">{{ status }}</span>
                      </div>
                      <div style="margin-top:8px;">
                        <div class="muted">{{ input_label }}</div>
                        <pre style="white-space:pre-wrap; background:#0f172a; padding:8px; border-radius:8px; border:1px solid #1f2937;">{{ case.input or "" }}</pre>
                      </div>
                      <div style="margin-top:8px;">
                        <div class="muted">Output</div>
                        <pre style="white-space:pre-wrap; background:#0f172a; padding:8px; border-radius:8px; border:1px solid #1f2937;">{{ case.output or "" }}</pre>
                      </div>
                      <div style="margin-top:8px;">
                        <div class="muted">Expected</div>
                        <pre style="white-space:pre-wrap; background:#0f172a; padding:8px; border-radius:8px; border:1px solid #1f2937;">{{ case.expected or "" }}</pre>
                      </div>
                      {% if case.plot_images %}
                        <div style="margin-top:8px;">
                          <div class="muted">Plots</div>
                          {% for img in case.plot_images %}
                            <img src="data:image/png;base64,{{ img }}" alt="Plot {{ loop.index }}" style="display:block; max-width:100%; border:1px solid #1f2937; border-radius:8px; margin-top:6px;">
                          {% endfor %}
                        </div>
                      {% endif %}
                      {% if case.error %}
                        <div style="margin-top:8px;">
                          <div class="muted">Error</div>
                          <pre style="white-space:pre-wrap; background:#1f2937; padding:8px; border-radius:8px; border:1px solid #334155;">{{ case.error }}</pre>
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
              {% if hidden_cases %}
                <div style="margin-top:12px;">
                  <div class="muted" style="font-size:0.85rem;">Hidden tests</div>
                  {% for case in hidden_cases %}
                    {% set status = case.status or "unknown" %}
                    {% set status_color = "#38bdf8" %}
                    {% if status == "passed" %}
                      {% set status_color = "#4ade80" %}
                    {% elif status in ("mismatch", "timeout") %}
                      {% set status_color = "#fbbf24" %}
                    {% elif status == "error" %}
                      {% set status_color = "#f87171" %}
                    {% endif %}
                    <div style="margin-top:8px; padding:10px; border-radius:10px; border:1px solid #1f2937; background:#0b1220;">
                      <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
                        <strong>{{ case.name or "Hidden test" }}</strong>
                        <span style="font-size:0.85rem; padding:4px 10px; border-radius:20px; border:1px solid {{ status_color }}; color:{{ status_color }};">{{ status }}</span>
                      </div>
                      <div style="margin-top:8px;">
                        <div class="muted">{{ input_label }}</div>
                        <pre style="white-space:pre-wrap; background:#0f172a; padding:8px; border-radius:8px; border:1px solid #1f2937;">{{ case.input or "" }}</pre>
                      </div>
                      <div style="margin-top:8px;">
                        <div class="muted">Output</div>
                        <pre style="white-space:pre-wrap; background:#0f172a; padding:8px; border-radius:8px; border:1px solid #1f2937;">{{ case.output or "" }}</pre>
                      </div>
                      <div style="margin-top:8px;">
                        <div class="muted">Expected</div>
                        <pre style="white-space:pre-wrap; background:#0f172a; padding:8px; border-radius:8px; border:1px solid #1f2937;">{{ case.expected or "" }}</pre>
                      </div>
                      {% if case.plot_images %}
                        <div style="margin-top:8px;">
                          <div class="muted">Plots</div>
                          {% for img in case.plot_images %}
                            <img src="data:image/png;base64,{{ img }}" alt="Plot {{ loop.index }}" style="display:block; max-width:100%; border:1px solid #1f2937; border-radius:8px; margin-top:6px;">
                          {% endfor %}
                        </div>
                      {% endif %}
                      {% if case.error %}
                        <div style="margin-top:8px;">
                          <div class="muted">Error</div>
                          <pre style="white-space:pre-wrap; background:#1f2937; padding:8px; border-radius:8px; border:1px solid #334155;">{{ case.error }}</pre>
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endif %}
          </div>
        {% endif %}
        {% if qlogs %}
          <details style="margin-top:10px;">
            <summary class="muted">Run history ({{ qlogs|length }})</summary>
            <ul style="margin:8px 0 0 16px; padding:0; list-style:square;">
              {% for log in qlogs %}
                <li style="margin-bottom:6px;">
                  {{ log.ts or log.timestamp or "—" }}
                  {% if log.samples %}
                    <ul style="margin:4px 0 0 14px; list-style:circle;">
                      {% for sample in log.samples %}
                        <li>{{ sample.name or ("Sample " ~ loop.index) }} — {{ sample.status or "ran" }}</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </details>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  {% endif %}
{% endmacro %}

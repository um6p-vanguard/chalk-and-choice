{% extends "base.html" %}
{% block content %}
<div class="card" style="max-width:1100px;">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">Live Class Signals</h3>
    <div class="muted">Rolling window: last {{ window_min }} minutes</div>
  </div>

  <div class="row" style="gap:12px; margin-top:12px; flex-wrap:wrap;">
    <div class="card" style="min-width:220px;">
      <div class="muted">All good</div>
      <div id="count-ok" style="font-size:36px; font-weight:700;">0</div>
    </div>
    <div class="card" style="min-width:220px;">
      <div class="muted">Confused</div>
      <div id="count-conf" style="font-size:36px; font-weight:700;">0</div>
    </div>
    <div class="card" style="min-width:220px;">
      <div class="muted">Unanswered questions</div>
      <div id="count-q" style="font-size:36px; font-weight:700;">0</div>
    </div>
    <div class="row" style="margin-left:auto; gap:8px;">
      <button class="btn" id="refresh-qs">Refresh questions</button>
      <button class="btn" id="show-open">Show open</button>
      <button class="btn" id="show-all">Show all</button>
    </div>
  </div>

  <div class="sp"></div>
  <h4 style="margin:0 0 8px 0;">Questions</h4>
  <div id="q-list" class="card" style="padding:0;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="padding:8px 10px; border-bottom:1px solid #334155;">When (UTC)</th>
          <th style="padding:8px 10px; border-bottom:1px solid #334155;">Student</th>
          <th style="padding:8px 10px; border-bottom:1px solid #334155;">Question</th>
          <th style="padding:8px 10px; border-bottom:1px solid #334155; text-align:right;">Action</th>
        </tr>
      </thead>
      <tbody id="q-body"></tbody>
    </table>
  </div>
</div>

<script>
(function(){
  // --- Live counts via SSE ---
  const es = new EventSource("{{ url_for('signals_stream') }}");
  es.onmessage = (e) => {
    try{
      const d = JSON.parse(e.data);
      document.getElementById("count-ok").textContent = d.ok;
      document.getElementById("count-conf").textContent = d.confused;
      document.getElementById("count-q").textContent = d.unread_questions;
    }catch(err){ console.error(err); }
  };

  // --- Questions list (poll on demand) ---
  const csrf = "{{ csrf_token() }}";
  const tbody = document.getElementById("q-body");
  let filter = "open"; // "open" | "all"

  async function loadQuestions(){
    const url = new URL("{{ url_for('questions_list') }}", window.location.origin);
    if (filter === "open") url.searchParams.set("state","open");
    const r = await fetch(url, { credentials: "same-origin" });
    const j = await r.json();
    tbody.innerHTML = "";
    for (const it of j.items){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:8px 10px; border-bottom:1px solid #334155;" class="muted">${it.when}</td>
        <td style="padding:8px 10px; border-bottom:1px solid #334155;">${it.student_name || ""}</td>
        <td style="padding:8px 10px; border-bottom:1px solid #334155;">${escapeHtml(it.text)}</td>
        <td style="padding:8px 10px; border-bottom:1px solid #334155; text-align:right;">
          ${it.handled ? '<span class="muted">Handled</span>' :
            '<button class="btn btn-primary" data-action="handle" data-id="'+it.id+'">Mark handled</button>'}
        </td>`;
      tbody.appendChild(tr);
    }
  }

  tbody.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-action='handle']");
    if (!btn) return;
    const id = btn.getAttribute("data-id");
    const r = await fetch(`{{ url_for('question_mark_handled', q_id=0) }}`.replace("0", id), {
      method: "POST",
      headers: {"Content-Type":"application/json", "X-CSRF": csrf},
      body: JSON.stringify({handled: true}),
      credentials: "same-origin"
    });
    if (r.ok) loadQuestions();
  });

  document.getElementById("refresh-qs").addEventListener("click", loadQuestions);
  document.getElementById("show-open").addEventListener("click", ()=>{ filter="open"; loadQuestions(); });
  document.getElementById("show-all").addEventListener("click", ()=>{ filter="all"; loadQuestions(); });

  // small util
  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // initial load
  loadQuestions();
})();
</script>
{% endblock %}

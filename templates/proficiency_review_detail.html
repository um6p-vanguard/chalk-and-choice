{% extends "base.html" %}
{% block content %}
<style>
  .code-display {
    background:#0b1220;
    border:1px solid var(--border);
    border-radius:10px;
    padding:16px;
    font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:13px;
    overflow-x:auto;
    white-space:pre-wrap;
    line-height:1.5;
  }
  .test-result { padding:8px 12px; border-radius:6px; margin:4px 0; }
  .test-result.passed { background:rgba(74,222,128,0.15); border-left:3px solid #4ade80; }
  .test-result.failed { background:rgba(239,68,68,0.15); border-left:3px solid #ef4444; }
  .test-result.error { background:rgba(251,191,36,0.15); border-left:3px solid #fbbf24; }
  .exercise-section { background:#1f2937; padding:20px; border-radius:12px; margin-bottom:20px; }
  .score-badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:0.9rem; font-weight:600; }
  .score-badge.good { background:rgba(74,222,128,0.2); color:#4ade80; }
  .score-badge.partial { background:rgba(251,191,36,0.2); color:#fbbf24; }
  .score-badge.bad { background:rgba(239,68,68,0.2); color:#ef4444; }
</style>

<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <div>
      <h2 style="margin:0 0 6px 0;">Review: {{ attempt.student.name }}</h2>
      <span class="muted">Submitted: {{ attempt.submitted_at.strftime('%Y-%m-%d %H:%M') if attempt.submitted_at else 'N/A' }}</span>
    </div>
    <a href="{{ url_for('proficiency_reviews') }}" class="btn">← Back to Reviews</a>
  </div>

  {% if attempt.status == 'submitted' %}
  <div style="background:rgba(99,127,190,0.2); border:1px solid var(--brand); padding:16px; border-radius:10px; margin-bottom:20px;">
    <strong>Status:</strong> Awaiting your decision
  </div>
  {% elif attempt.status == 'passed' %}
  <div style="background:rgba(74,222,128,0.15); border:1px solid #4ade80; padding:16px; border-radius:10px; margin-bottom:20px;">
    <strong style="color:#4ade80;">✓ PASSED</strong> by {{ attempt.reviewer.name if attempt.reviewer else 'N/A' }} on {{ attempt.reviewed_at.strftime('%Y-%m-%d %H:%M') if attempt.reviewed_at else 'N/A' }}
  </div>
  {% else %}
  <div style="background:rgba(239,68,68,0.15); border:1px solid #ef4444; padding:16px; border-radius:10px; margin-bottom:20px;">
    <strong style="color:#ef4444;">✗ FAILED</strong> by {{ attempt.reviewer.name if attempt.reviewer else 'N/A' }} on {{ attempt.reviewed_at.strftime('%Y-%m-%d %H:%M') if attempt.reviewed_at else 'N/A' }}
  </div>
  {% endif %}

  {% for sub in attempt.submissions %}
  <div class="exercise-section">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;">
      <div>
        <h3 style="margin:0 0 6px 0;">Exercise {{ loop.index }}: {{ sub.exercise_title }}</h3>
        {% if sub.exercise_description %}
        <p class="muted" style="margin:0;">{{ sub.exercise_description[:200] }}{% if sub.exercise_description|length > 200 %}...{% endif %}</p>
        {% endif %}
      </div>
      <div style="text-align:right;">
        {% set visible_pct = (sub.visible_passed / sub.visible_total * 100) if sub.visible_total > 0 else 0 %}
        {% set hidden_pct = (sub.hidden_passed / sub.hidden_total * 100) if sub.hidden_total > 0 else 0 %}
        <div>
          <span class="muted">Visible:</span>
          <span class="score-badge {% if visible_pct == 100 %}good{% elif visible_pct >= 50 %}partial{% else %}bad{% endif %}">
            {{ sub.visible_passed }}/{{ sub.visible_total }}
          </span>
        </div>
        <div style="margin-top:6px;">
          <span class="muted">Hidden:</span>
          <span class="score-badge {% if hidden_pct == 100 %}good{% elif hidden_pct >= 50 %}partial{% else %}bad{% endif %}">
            {{ sub.hidden_passed }}/{{ sub.hidden_total }}
          </span>
        </div>
      </div>
    </div>

    <h4>Student's Code</h4>
    <div class="code-display">{{ sub.code or '(No code submitted)' }}</div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
      <div>
        <h4 style="color:#4ade80;">Visible Test Results</h4>
        {% if sub.visible_results_json %}
          {% for r in sub.visible_results_json %}
          <div class="test-result {{ r.status }}">
            <strong>{{ r.name }}</strong>: {{ r.status }}
            {% if r.error %}<div class="muted" style="font-size:0.85rem;">{{ r.error }}</div>{% endif %}
            {% if r.status != 'passed' and r.expected %}<div class="muted" style="font-size:0.85rem;">Expected: {{ r.expected }}</div>{% endif %}
            {% if r.status != 'passed' and r.output %}<div class="muted" style="font-size:0.85rem;">Got: {{ r.output }}</div>{% endif %}
          </div>
          {% endfor %}
        {% else %}
          <p class="muted">No visible tests</p>
        {% endif %}
      </div>
      
      <div>
        <h4 style="color:#fbbf24;">Hidden Test Results</h4>
        {% if sub.hidden_results_json %}
          {% for r in sub.hidden_results_json %}
          <div class="test-result {{ r.status }}">
            <strong>{{ r.name }}</strong>: {{ r.status }}
            {% if r.error %}<div class="muted" style="font-size:0.85rem;">{{ r.error }}</div>{% endif %}
            {% if r.status != 'passed' and r.expected %}<div class="muted" style="font-size:0.85rem;">Expected: {{ r.expected }}</div>{% endif %}
            {% if r.status != 'passed' and r.output %}<div class="muted" style="font-size:0.85rem;">Got: {{ r.output }}</div>{% endif %}
          </div>
          {% endfor %}
        {% else %}
          <p class="muted">No hidden tests</p>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}

  {% if attempt.status == 'submitted' %}
  <hr style="border-color:var(--border); margin:24px 0;">
  
  <div style="display:flex; gap:16px; justify-content:center;">
    <form method="POST" style="display:inline;">
      <input type="hidden" name="action" value="pass">
      <button type="submit" class="btn btn-primary" style="font-size:1.1rem; padding:14px 32px;" onclick="return confirm('Mark this student as PASSED? They will receive the Python proficiency tag.');">
        ✓ Pass Student
      </button>
    </form>
    
    <form method="POST" style="display:inline;">
      <input type="hidden" name="action" value="fail">
      <button type="submit" class="btn btn-danger" style="font-size:1.1rem; padding:14px 32px;" onclick="return confirm('Mark this student as FAILED? They will need to wait for the cooldown period before retrying.');">
        ✗ Fail Student
      </button>
    </form>
  </div>
  {% endif %}
</div>
{% endblock %}

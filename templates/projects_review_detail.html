{% extends "base.html" %}
{% import "_task_answers.html" as task_answers %}
{% block content %}
<div class="card">
  <div class="row" style="justify-content:space-between; align-items:flex-start;">
    <div>
      <h3 style="margin:0;">{{ project.title if project else "Project" }} ‚Äî {{ task.title if task else "Task" }}</h3>
      <p class="muted" style="margin-top:4px;">
        Student: <strong>{{ submission.student_name or "Unknown" }}</strong>
        {% if submission.student %}
          {% if submission.student.is_flagged %}
          <span style="background: {% if submission.student.flag_status == 'confirmed' %}#dc2626{% else %}#637FBE{% endif %}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px; font-weight: bold;">
            üö© {{ submission.student.flag_status|upper }}
          </span>
          {% endif %}
          {% if submission_warnings|length > 0 %}
          <span style="background: #5775B8; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px; font-weight: bold;">‚ö†Ô∏è {{ submission_warnings|length }} WARNING(S) FOR THIS TASK</span>
          {% endif %}
        {% endif %}
      </p>
      <p class="muted" style="margin-top:4px;">Submitted: {{ submission.submitted_at.strftime("%b %d %H:%M") if submission.submitted_at else "‚Äî" }}</p>
      {% if active_attempt %}
        <p class="muted" style="margin-top:4px;">
          Attempt {{ active_attempt.attempt_number }}
          {% if active_attempt.reviewed_at %} ‚Ä¢ Reviewed {{ active_attempt.reviewed_at.strftime("%b %d %H:%M") }}{% endif %}
          {% if active_attempt.reviewer %} ‚Ä¢ Reviewer: {{ active_attempt.reviewer.name }}{% endif %}
        </p>
      {% endif %}
      {% if review_attempt and not is_latest_attempt %}
        <p class="muted" style="margin-top:4px;">Note: This is not the latest attempt. Updates will only change this attempt's history.</p>
      {% endif %}
      {% if task and task.resource_file %}
        <div style="margin-top:8px;">
          <span class="muted">Task resource:</span>
          <a class="btn" href="{{ url_for('project_task_resource_download', task_id=task.id) }}">Download</a>
        </div>
      {% endif %}
    </div>
    <div class="row" style="gap:8px;">
      {% if submission.student %}
        <a class="btn" href="{{ url_for('warnings_student_detail', student_id=submission.student.id) }}" style="background: #5775B8; color: white; border: none;">View All Warnings</a>
      {% endif %}
      <a class="btn" href="{{ url_for('projects_reviews_mine') }}">My reviews</a>
      <a class="btn" href="{{ url_for('projects_reviews') }}">Back to review list</a>
      {% if submission.student_id %}
        <a class="btn" href="{{ url_for('projects_submission_task_detail', code=project.code, student_id=submission.student_id, task_id=task.id) }}">Open task view</a>
      {% endif %}
    </div>
  </div>
  
  {# Show submission-specific warnings first #}
  {% if submission_warnings|length > 0 %}
  <div style="margin-top: 20px; padding: 15px; background: rgba(220, 38, 38, 0.1); border-left: 4px solid #dc2626; border-radius: 6px;">
    <strong style="color: #dc2626;">
      ‚ö†Ô∏è Warnings for This Submission ({{ submission_warnings|length }})
    </strong>
    <ul style="margin: 10px 0 0; padding-left: 20px;">
      {% for warning in submission_warnings %}
      <li style="margin: 8px 0;">
        <strong>{{ warning.type|replace("_", " ")|title }}</strong> 
        <span style="font-size: 11px; color: {% if warning.severity == 'high' %}#dc2626{% elif warning.severity == 'medium' %}#f59e0b{% else %}#94a3b8{% endif %}; text-transform: uppercase; font-weight: bold;">[{{ warning.severity }}]</span>
        <br>
        <span style="color: #e5e7eb; font-size: 13px;">{{ warning.description }}</span>
        <br>
        <small style="color: #94a3b8;">{{ warning.timestamp[:16] if warning.timestamp else "" }}</small>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
  
  {# Show flag status if flagged #}
  {% if submission.student and submission.student.is_flagged %}
  <div style="margin-top: 15px; padding: 15px; background: {% if submission.student.flag_status == 'confirmed' %}rgba(220, 38, 38, 0.15){% else %}rgba(99, 127, 190, 0.1){% endif %}; border-left: 4px solid {% if submission.student.flag_status == 'confirmed' %}#dc2626{% else %}#637FBE{% endif %}; border-radius: 6px;">
    <strong style="color: {% if submission.student.flag_status == 'confirmed' %}#dc2626{% else %}#637FBE{% endif %};">
      üö© Student Flag Status: {{ submission.student.flag_status|replace("_", " ")|title }}
    </strong>
    {% if submission.student.flag_notes %}
    <p style="margin: 8px 0 0; color: #94a3b8;">{{ submission.student.flag_notes }}</p>
    {% endif %}
    {% if submission.student.flagged_at %}
    <p style="margin: 4px 0 0; color: #64748b; font-size: 12px;">
      Flagged on {{ submission.student.flagged_at.strftime("%Y-%m-%d %H:%M") }}
      {% if submission.student.flagged_by %} by {{ submission.student.flagged_by.name }}{% endif %}
    </p>
    {% endif %}
  </div>
  {% endif %}
</div>
<div class="sp"></div>
<div class="card">
  {{ task_answers.render(questions, answers, logs_by_question, grading_by_question=grading_by_question, show_meta=True, task_auto_grade=(task.auto_grade if task else True), code_runs_enabled=code_runs_enabled, submission_id=submission.id, attempt_id=latest_attempt_id) }}
</div>
<div class="sp"></div>
<div class="card">
  <h3 style="margin:0 0 16px 0;">Review Decision</h3>
  <form method="post" action="{{ url_for('projects_review_decision', submission_id=submission.id) }}">
    <input type="hidden" name="csrf" value="{{ csrf_token() }}">
    {% if active_attempt %}
      <input type="hidden" name="attempt_id" value="{{ active_attempt.id }}">
    {% endif %}
    <div style="margin-bottom:16px;">
      <label style="display:block; margin-bottom:6px; font-weight:500;">Reviewer Notes (optional)</label>
      {% set review_notes = (active_attempt.review_notes if active_attempt and active_attempt.review_notes else (submission.review_notes or "")) %}
      <textarea name="review_notes" rows="4" placeholder="Add feedback for the student..." style="width:100%; min-height:100px; padding:10px; border:1px solid #334155; border-radius:8px; background:#0f172a; color:#e2e8f0; font-family:inherit; font-size:0.95rem;">{{ review_notes }}</textarea>
    </div>
    <div class="row" style="gap:10px; flex-wrap:wrap;">
      <button class="btn" type="submit" name="action" value="accept" style="background:#10b981; color:#fff; border:none; padding:10px 20px; font-weight:500; font-size:0.95rem; min-width:120px;">‚úì Accept</button>
      <button class="btn" type="submit" name="action" value="need_rework" style="background:#f59e0b; color:#fff; border:none; padding:10px 20px; font-weight:500; font-size:0.95rem; min-width:140px;">‚Üª Need Rework</button>
      <button class="btn" type="submit" name="action" value="reject" style="background:#ef4444; color:#fff; border:none; padding:10px 20px; font-weight:500; font-size:0.95rem; min-width:120px;">‚úï Reject</button>
    </div>
  </form>
</div>
{% endblock %}

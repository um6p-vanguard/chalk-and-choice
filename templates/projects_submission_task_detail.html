{% extends "base.html" %}
{% import "_task_answers.html" as task_answers %}
{% block content %}
<div class="card">
  <div class="row" style="justify-content:space-between; align-items:flex-start;">
    <div>
      <h3 style="margin:0;">{{ task.title }}</h3>
      <p class="muted" style="margin:4px 0;">Project: {{ project.title }} ({{ project.code }})</p>
      <p class="muted" style="margin:4px 0;">Student: {{ student.name or "Unknown" }} — {{ student.email or "No email" }}</p>
      <p class="muted" style="margin:4px 0;">Status:
        {% if submission.status == "accepted" %}
          <span style="color:#4ade80;">Accepted</span>
        {% elif submission.status == "pending_review" %}
          <span style="color:#fde047;">Pending review</span>
        {% elif submission.status == "rejected" %}
          <span style="color:#f87171;">Needs rework</span>
        {% elif submission.status == "submitted" %}
          <span style="color:#38bdf8;">Submitted</span>
        {% else %}
          <span class="muted">In progress</span>
        {% endif %}
      </p>
      <p class="muted" style="margin:4px 0;">
        Submitted: {{ submission.submitted_at.strftime("%b %d %H:%M") if submission.submitted_at else "—" }} •
        Last activity: {{ submission.last_activity_at.strftime("%b %d %H:%M") if submission.last_activity_at else "—" }}
      </p>
      {% if task and task.resource_file %}
        <div style="margin-top:8px;">
          <span class="muted">Task resource:</span>
          <a class="btn" href="{{ url_for('project_task_resource_download', task_id=task.id) }}">Download</a>
        </div>
      {% endif %}
      {% set review_notes = latest_attempt.review_notes if (latest_attempt and latest_attempt.review_notes) else (submission.review_notes or "") %}
      {% set reviewer_name = latest_attempt.reviewer.name if (latest_attempt and latest_attempt.reviewer) else "" %}
      {% if review_notes or reviewer_name %}
        <div style="margin-top:6px; padding:10px; border:1px dashed #334155; border-radius:10px;">
          <strong>Reviewer notes</strong>
          {% if reviewer_name %}
            <div class="muted" style="margin-top:4px;">Reviewed by {{ reviewer_name }}</div>
          {% endif %}
          {% if review_notes %}
            <p class="muted" style="margin:6px 0 0 0; white-space:pre-line;">{{ review_notes }}</p>
          {% endif %}
        </div>
      {% endif %}
    </div>
    {% if user %}
      <div class="row" style="gap:8px;">
        <a class="btn" href="{{ url_for('projects_student_submissions', code=project.code, student_id=student.id) }}">Back to tasks</a>
        <a class="btn" href="{{ url_for('projects_submissions_overview', code=project.code) }}">All attempts</a>
      </div>
    {% else %}
      <div class="row" style="gap:8px;">
        <a class="btn" href="{{ url_for('student_projects') }}">Back to projects</a>
      </div>
    {% endif %}
  </div>
</div>
<div class="sp"></div>
<div class="card">
  <h3 style="margin-top:0;">Student responses</h3>
  {{ task_answers.render(questions, answers, logs_by_question, grading_by_question=grading_by_question, show_meta=(user is not none), task_auto_grade=(task.auto_grade if task else True), code_runs_enabled=code_runs_enabled, submission_id=submission.id, attempt_id=latest_attempt_id) }}
</div>
{% if user and attempt_rows %}
<div class="sp"></div>
<div class="card">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">Attempt history</h3>
    <span class="muted" style="font-size:0.95rem;">{{ attempt_rows|length }} total</span>
  </div>
  <div style="margin-top:12px; display:flex; flex-direction:column; gap:12px;">
    {% for row in attempt_rows %}
      {% set attempt = row.attempt %}
      <details style="border:1px solid #1f2937; border-radius:12px; padding:12px; background:#0b1220;">
        <summary style="cursor:pointer; user-select:none;">
          <strong>Attempt {{ attempt.attempt_number }}</strong>
          <span class="muted" style="margin-left:8px;">
            {{ attempt.submitted_at.strftime("%b %d %H:%M") if attempt.submitted_at else "—" }}
          </span>
          <span class="muted" style="margin-left:8px;">Status: {{ attempt.status }}</span>
          <span class="muted" style="margin-left:8px;">Score: {{ "%.1f"|format(attempt.score or 0) }} / {{ "%.1f"|format(attempt.max_score or 0) }}</span>
          {% if attempt.reviewer %}
            <span class="muted" style="margin-left:8px;">Reviewed by {{ attempt.reviewer.name }}</span>
          {% endif %}
        </summary>
        {% if attempt.review_notes %}
          <div style="margin-top:10px; padding:10px; border:1px dashed #334155; border-radius:10px;">
            <strong>Reviewer notes</strong>
            <p class="muted" style="margin:6px 0 0 0; white-space:pre-line;">{{ attempt.review_notes }}</p>
          </div>
        {% endif %}
        <div style="margin-top:12px;">
          {{ task_answers.render(questions, row.answers, row.logs_by_question, grading_by_question=row.grading_by_question, show_meta=True, task_auto_grade=(task.auto_grade if task else True), code_runs_enabled=code_runs_enabled, submission_id=submission.id, attempt_id=attempt.id) }}
        </div>
      </details>
    {% endfor %}
  </div>
</div>
{% endif %}
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="card">
  <h3>{{ form.title }}</h3>
  <div id="surveyContainer"></div>
</div>

<!-- SurveyJS: minimal vanilla setup -->
<link href="https://unpkg.com/survey-core/defaultV2.min.css" rel="stylesheet">
<script src="https://unpkg.com/survey-core/survey.core.min.js"></script>
<script src="https://unpkg.com/survey-js-ui/survey-js-ui.min.js"></script>

<script>
(function(){
  // The schema comes from Flask; we safely JSON-encode it into the page
  const schema = {{ form.schema_json|tojson }};
  const survey = new Survey.Model(schema);

  survey.onComplete.add(async function(sender){
    const payload = sender.data || {};
    const csrf = "{{ csrf_token() }}";
    const res = await fetch("{{ url_for('form_submit', code=form.code) }}", {
      method: "POST",
      headers: {"Content-Type": "application/json", "X-CSRF": csrf},
      body: JSON.stringify(payload),
      credentials: "same-origin"
    });
    // Always redirect to thank-you (reuse poll thanks)
    window.location = "{{ url_for('poll_thanks', code='dummy') }}".replace("dummy", "{{ form.code }}");
  });

  // Render into container
  const el = document.getElementById("surveyContainer");
  SurveyUI.render(survey, el);
})();
</script>
{% endblock %}

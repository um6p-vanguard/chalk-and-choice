{% extends "base.html" %}
{% block content %}
<div class="card">
  <h3>{{ form.title }}</h3>
  <div id="surveyContainer"></div>
</div>

<!-- SurveyJS (vanilla JS): core CSS/JS first, then UI wrapper -->
<link rel="stylesheet" href="{{ url_for('static', filename='survey/survey-core.min.css') }}">
<script src="{{ url_for('static', filename='survey/survey.core.min.js') }}"></script>
<script src="{{ url_for('static', filename='survey/survey-js-ui.min.js') }}"></script>

<script>
(function(){
  // Inject schema; if DB stores it as a JSON string, parse it.
  let schema = {{ form.schema_json | tojson | safe }};
  if (typeof schema === "string") {
    try { schema = JSON.parse(schema); } catch (e) {
      console.error("Bad schema JSON:", e, schema);
      schema = {};
    }
  }

  // Build model and render
  const survey = new Survey.Model(schema);

  // Submit to backend and then show thanks
  survey.onComplete.add(async function(sender){
    const payload = sender.data || {};
    const csrf = "{{ csrf_token() }}";
    await fetch("{{ url_for('form_submit', code=form.code) }}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRF": csrf },
      body: JSON.stringify(payload),
      credentials: "same-origin"
    });
    window.location = "{{ url_for('poll_thanks', code=form.code) }}";
  });

  const el = document.getElementById("surveyContainer");
  // Correct vanilla render call (no SurveyUI.render here)
  survey.render(el);
})();
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="card">
  <h3 style="margin:0;">Pending task reviews</h3>
  <p class="muted" style="margin-top:6px;">Approve or reject submissions for tasks that require mentor feedback.</p>
  <div style="margin-top:10px;">
    <a class="btn" href="{{ url_for('projects_reviews_mine') }}">My reviews</a>
  </div>
  
  {% if flagged_count > 0 or warned_count > 0 %}
  <div style="margin-top: 15px; padding: 10px; background: rgba(99, 127, 190, 0.1); border-left: 4px solid #637FBE; border-radius: 6px;">
    <strong>âš ï¸ Academic Integrity Alerts:</strong>
    {% if flagged_count > 0 %}
    <span style="color: #637FBE;">{{ flagged_count }} flagged student(s)</span>
    {% endif %}
    {% if warned_count > 0 %}
    {% if flagged_count > 0 %} â€¢ {% endif %}
    <span style="color: #5775B8;">{{ warned_count }} warned student(s)</span>
    {% endif %}
  </div>
  {% endif %}
</div>
<div class="sp"></div>
<div class="card">
  <form method="get" class="row" style="gap:10px; flex-wrap:wrap; align-items:flex-end;">
    <div>
      <label>Project filter</label>
      <select name="project_id">
        <option value="">All projects</option>
        {% for project in projects %}
          <option value="{{ project.id }}" {% if filter_project_id == project.id %}selected{% endif %}>{{ project.title }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Warning filter</label>
      <select name="warning_filter">
        <option value="all" {% if filter_warning == 'all' %}selected{% endif %}>All students</option>
        <option value="flagged" {% if filter_warning == 'flagged' %}selected{% endif %}>ğŸš© Flagged only ({{ flagged_count }})</option>
        <option value="warned" {% if filter_warning == 'warned' %}selected{% endif %}>âš ï¸ Warned only ({{ warned_count }})</option>
        <option value="clean" {% if filter_warning == 'clean' %}selected{% endif %}>âœ“ Clean only</option>
      </select>
    </div>
    <div>
      <label>Sort</label>
      <select name="sort">
        <option value="newest" {% if filter_sort == 'newest' %}selected{% endif %}>Newest first</option>
        <option value="oldest" {% if filter_sort == 'oldest' %}selected{% endif %}>Oldest first</option>
      </select>
    </div>
    <button class="btn" type="submit">Apply</button>
  </form>
  {% if submissions %}
    <table style="margin-top:12px;">
      <thead>
        <tr>
          <th>Student</th>
          <th>Groups</th>
          <th>Status</th>
          <th>Project</th>
          <th>Task</th>
          <th>Submitted</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for sub in submissions %}
        <tr {% if sub.student and sub.student.is_flagged %}style="background: rgba(99, 127, 190, 0.05);"{% endif %}>
          <td>
            <strong>{{ sub.student_name or "Unknown" }}</strong>
            {% if sub.student %}
              {% if sub.student.is_flagged %}
              <br><span style="background: #637FBE; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">ğŸš© FLAGGED</span>
              {% elif sub.has_warnings_for_this_task %}
              <br><a href="{{ url_for('warnings_student_detail', student_id=sub.student.id) }}" 
                     style="background: #5775B8; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; text-decoration: none; font-weight: bold;">
                âš ï¸ warning(s)
              </a>
              {% endif %}
            {% endif %}
          </td>
          <td>
            {% if sub.student and sub.student.group_memberships %}
              {% for membership in sub.student.group_memberships %}
                {{ membership.group.name if membership.group else "(deleted)" }}{% if not loop.last %}, {% endif %}
              {% endfor %}
            {% else %}
              <span class="muted">â€”</span>
            {% endif %}
          </td>
          <td>
            {% if sub.student %}
              {% if sub.student.is_flagged %}
              <a href="{{ url_for('warnings_student_detail', student_id=sub.student.id) }}" 
                 style="color: #d33; text-decoration: none; font-weight: bold;" title="View warning details">
                ğŸš© Flagged
              </a>
              {% elif sub.has_warnings_for_this_task %}
              <a href="{{ url_for('warnings_student_detail', student_id=sub.student.id) }}" 
                 style="color: #f59e0b; text-decoration: none; font-weight: bold;" title="View warning details">
                âš ï¸ Warned
              </a>
              {% else %}
              <span style="color: #10b981;">âœ“ Clean</span>
              {% endif %}
            {% else %}
              <span class="muted">â€”</span>
            {% endif %}
          </td>
          <td>{{ sub.project.title if sub.project else "â€”" }}</td>
          <td>{{ sub.task.title if sub.task else "â€”" }}</td>
          <td>{{ sub.submitted_at.strftime("%b %d %H:%M") if sub.submitted_at else "â€”" }}</td>
          <td>
            <div class="row" style="gap:6px; flex-wrap:wrap;">
              <a class="btn" href="{{ url_for('projects_review_detail', submission_id=sub.id) }}" target="_blank">View</a>
            </div>
            <form method="post" action="{{ url_for('projects_review_decision', submission_id=sub.id) }}" style="display:flex; gap:6px; flex-wrap:wrap;">
              <input type="hidden" name="csrf" value="{{ csrf_token() }}">
              <input type="text" name="review_notes" placeholder="Notes" style="flex:1; min-width:140px;">
              <button class="btn btn-primary" name="action" value="accept">Accept</button>
              <button class="btn btn-danger" name="action" value="reject">Reject</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted" style="margin-top:12px;">
      {% if filter_warning == 'flagged' %}
        No submissions from flagged students need review.
      {% elif filter_warning == 'warned' %}
        No submissions from warned students need review.
      {% elif filter_warning == 'clean' %}
        No submissions from clean students need review.
      {% else %}
        No submissions need review.
      {% endif %}
    </p>
  {% endif %}
</div>
{% endblock %}

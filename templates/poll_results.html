{% extends "base.html" %}
{% block content %}
<div class="card">
  <h3>Results</h3>

  <p class="q">{{ poll.question|e }}</p>
  <p class="muted">
    Code: <strong>{{ poll.code }}</strong> ·
    Status: <strong>{{ "OPEN" if poll.is_open else "CLOSED" }}</strong> ·
    Options: {{ poll.options|length }}
  </p>

  {# --- Summary bars --- #}
  {% set total = counts|sum %}
  {% if total == 0 %}
    <p class="muted">No votes yet.</p>
  {% endif %}

  <div id="results-bars">
    {% for opt in poll.options %}
      {% set count = counts[loop.index0] %}
      {% set pct = (100 * count / total) if total else 0 %}
      <div style="margin:12px 0;">
        <div style="display:flex;justify-content:space-between;align-items:baseline;">
          <div>
            {% if poll.correct_index is not none and loop.index0 == poll.correct_index %}
              <strong>✅ {{ opt|e }}</strong>
            {% else %}
              {{ opt|e }}
            {% endif %}
          </div>
          <div class="muted">
            <span id="count-{{ loop.index0 }}">{{ count }}</span>
            ( <span id="pct-{{ loop.index0 }}">{{ '%.1f'|format(pct) }}</span>% )
          </div>
        </div>
        <div style="background:#0b1220;border:1px solid #334155;border-radius:8px;height:20px;">
          <div id="bar-{{ loop.index0 }}"
               style="background:var(--accent, #22c55e);height:20px;width: {{ '%.2f'|format(pct) }}%; border-radius:8px; transition: width .3s;">
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  {# --- Accuracy --- #}
  {% if accuracy is not none %}
    <p><strong>Accuracy:</strong>
      <span id="accuracy">{{ '%.1f'|format(accuracy * 100) }}</span>% (<span id="total-count-2">{{ total }}</span> responses)
    </p>
  {% else %}
    <p class="muted">Set a correct option index to track accuracy.</p>
  {% endif %}

  <div class="sp"></div>

  {# --- Instructor controls --- #}
  <div class="row" style="gap:8px;flex-wrap:wrap;">
    <form method="post" action="{{ url_for('poll_set_correct', code=poll.code) }}">
      <input type="hidden" name="csrf" value="{{ csrf_token() }}">
      <label>Correct option index (0-based):</label>
      <input type="text" name="correct" value="{{ poll.correct_index if poll.correct_index is not none }}" style="max-width:80px;">
      <button class="btn" type="submit">Save</button>
    </form>

    <form method="post" action="{{ url_for('poll_open', code=poll.code) }}">
      <input type="hidden" name="csrf" value="{{ csrf_token() }}">
      <button class="btn" type="submit" {% if poll.is_open %}disabled{% endif %}>Open voting</button>
    </form>

    <form method="post" action="{{ url_for('poll_close', code=poll.code) }}">
      <input type="hidden" name="csrf" value="{{ csrf_token() }}">
      <button class="btn" type="submit" {% if not poll.is_open %}disabled{% endif %}>Close voting</button>
    </form>

    <a class="btn" href="{{ url_for('export_csv', code=poll.code) }}">Export CSV</a>
    <a class="btn" href="{{ url_for('share', code=poll.code) }}">Share / QR</a>
  </div>

  <div class="sp"></div>

  {# --- Per-student table --- #}
  <div class="card" style="background:#0b1220;border:1px solid #334155;">
    <h4>Responses (<span id="total-count">{{ total }}</span>)</h4>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Choice</th>
            <th>Correct</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r.name }}</td>
              <td>
                {% set idx = r.choice %}
                {% if 0 <= idx < poll.options|length %}
                  {{ idx }} — {{ poll.options[idx] }}
                {% else %}
                  {{ idx }}
                {% endif %}
              </td>
              <td>
                {% if poll.correct_index is not none %}
                  {{ "Yes" if r.correct else "No" }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="muted">{{ r.when }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# --- Live updates via SSE without reloading the page --- #}
<script>
(function(){
  // Initial state from server render
  const initialCounts = {{ counts | tojson }};
  const correctIndex = {{ 'null' if poll.correct_index is none else poll.correct_index }};
  let lastCounts = initialCounts.slice();
  let firstMsg = true;

  function arraysEqual(a,b){
    if (a.length !== b.length) return false;
    for (let i=0;i<a.length;i++) if (a[i] !== b[i]) return false;
    return true;
  }

  function updateUI(data){
    const counts = data.counts || [];
    const total = (counts.reduce((s,x)=>s+(+x||0),0)) || 0;

    // per-option counts, pct, and bar widths
    for (let i=0;i<counts.length;i++){
      const c = counts[i];
      const pct = total ? (100 * c / total) : 0;
      const cEl = document.getElementById("count-"+i);
      const pEl = document.getElementById("pct-"+i);
      const bEl = document.getElementById("bar-"+i);
      if (cEl) cEl.textContent = c;
      if (pEl) pEl.textContent = pct.toFixed(1);
      if (bEl) bEl.style.width = pct.toFixed(2) + "%";
    }

    // totals (two places if present)
    const t1 = document.getElementById("total-count");
    const t2 = document.getElementById("total-count-2");
    if (t1) t1.textContent = total;
    if (t2) t2.textContent = total;

    // accuracy if we have a correct index
    if (typeof correctIndex === "number" && correctIndex >= 0) {
      const accEl = document.getElementById("accuracy");
      if (accEl && correctIndex < counts.length) {
        const correct = counts[correctIndex] || 0;
        const acc = total ? (100 * correct / total) : 0;
        accEl.textContent = acc.toFixed(1);
      }
    }
  }

  try {
    const es = new EventSource("{{ url_for('poll_stream', code=poll.code) }}");
    es.onmessage = function(ev){
      const data = JSON.parse(ev.data || "{}");
      const counts = data.counts || [];
      // Ignore the very first message if it's identical to what's already rendered
      if (firstMsg) {
        firstMsg = false;
        if (arraysEqual(counts, initialCounts)) return;
      }
      if (!arraysEqual(counts, lastCounts)) {
        lastCounts = counts.slice();
        updateUI(data);
      }
    };
    es.onerror = function(){ /* ignore; browser will auto-retry per retry hint */ };
  } catch(e) {
    // Fallback polling (no reload loop)
    setInterval(async ()=>{
      try{
        const r = await fetch("{{ url_for('poll_stats', code=poll.code) }}", {cache:"no-store"});
        if (!r.ok) return;
        const data = await r.json();
        if (data && Array.isArray(data.counts)) updateUI(data);
      }catch(_){}
    }, 3000);
  }
})();
</script>
{% endblock %}

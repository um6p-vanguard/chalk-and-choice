{% extends "base.html" %}
{% block title %}Warning Details - {{ student.name }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <div>
      <h1 style="margin: 0;">{{ student.name }}</h1>
      <p style="margin: 5px 0 0; color: #94a3b8;">{{ student.email }}</p>
    </div>
    {% if student.is_flagged %}
    <span style="background: {% if student.flag_status == 'confirmed' %}#dc2626{% elif student.flag_status == 'under_review' %}#f59e0b{% else %}#637FBE{% endif %}; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold;">
      ğŸš© {{ student.flag_status|replace("_", " ")|upper }}
    </span>
    {% elif student.flag_status == 'cleared' %}
    <span style="background: #10b981; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold;">
      âœ“ CLEARED
    </span>
    {% endif %}
  </div>

  <!-- Flag Actions -->
  <div class="card" style="margin-bottom: 30px;">
    <h3 style="margin-top: 0;">Flag Actions</h3>
    
    {% if student.is_flagged %}
    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start;">
      {# Change status options #}
      <form method="post" action="{{ url_for('warnings_flag_student', student_id=student.id) }}" style="display: flex; gap: 10px; align-items: center;">
        <input type="hidden" name="csrf" value="{{ csrf_token() }}">
        <select name="status" style="padding: 10px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb;">
          <option value="under_review" {% if student.flag_status == 'under_review' %}selected{% endif %}>Under Review</option>
          <option value="confirmed" {% if student.flag_status == 'confirmed' %}selected{% endif %}>Confirmed</option>
        </select>
        <input type="text" name="notes" placeholder="Update notes..." style="padding: 10px; width: 200px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb;">
        <button type="submit" class="btn" style="background: #637FBE; color: white; border: none;">
          Update Status
        </button>
      </form>
      
      <form method="post" action="{{ url_for('warnings_unflag_student', student_id=student.id) }}" style="display: flex; gap: 10px; align-items: center;">
        <input type="hidden" name="csrf" value="{{ csrf_token() }}">
        <input type="text" name="notes" placeholder="Reason for clearing..." style="padding: 10px; width: 200px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb;">
        <button type="submit" class="btn" style="background: #10b981; color: white; border: none;">
          âœ“ Clear Flag
        </button>
      </form>
    </div>
    {% else %}
    <form method="post" action="{{ url_for('warnings_flag_student', student_id=student.id) }}" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
      <input type="hidden" name="csrf" value="{{ csrf_token() }}">
      <select name="status" style="padding: 10px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb;">
        <option value="under_review">Under Review</option>
        <option value="confirmed">Confirmed</option>
      </select>
      <input type="text" name="notes" placeholder="Reason for flagging..." style="padding: 10px; width: 300px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: #e5e7eb;">
      <button type="submit" class="btn" style="background: #dc2626; color: white; border: none;">
        ğŸš© Flag Student
      </button>
    </form>
    {% endif %}

    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #334155;">
      <form method="post" action="{{ url_for('warnings_clear_all', student_id=student.id) }}" 
            style="display: inline-block;"
            onsubmit="return confirm('Clear all warnings and reset flag status for this student? This cannot be undone.');">
        <input type="hidden" name="csrf" value="{{ csrf_token() }}">
        <button type="submit" class="btn" style="background: #334155; color: #94a3b8;">
          ğŸ—‘ Clear All Warnings & Reset
        </button>
      </form>
    </div>
  </div>

  <!-- Flag Status Info -->
  {% if student.flag_notes or student.flagged_at %}
  <div style="background: {% if student.flag_status == 'confirmed' %}rgba(220, 38, 38, 0.1){% elif student.flag_status == 'under_review' %}rgba(245, 158, 11, 0.1){% elif student.flag_status == 'cleared' %}rgba(16, 185, 129, 0.1){% else %}rgba(99, 127, 190, 0.1){% endif %}; border-left: 4px solid {% if student.flag_status == 'confirmed' %}#dc2626{% elif student.flag_status == 'under_review' %}#f59e0b{% elif student.flag_status == 'cleared' %}#10b981{% else %}#637FBE{% endif %}; padding: 15px; margin-bottom: 30px; border-radius: 6px;">
    <div style="display: flex; justify-content: space-between; align-items: start;">
      <div>
        <strong>Current Status:</strong> 
        <span style="text-transform: uppercase; font-weight: bold; color: {% if student.flag_status == 'confirmed' %}#dc2626{% elif student.flag_status == 'under_review' %}#f59e0b{% elif student.flag_status == 'cleared' %}#10b981{% else %}#94a3b8{% endif %};">
          {{ student.flag_status|replace("_", " ") }}
        </span>
        {% if student.flag_notes %}
        <p style="margin: 8px 0 0; color: #e5e7eb;">{{ student.flag_notes }}</p>
        {% endif %}
      </div>
      <div style="text-align: right; color: #94a3b8; font-size: 13px;">
        {% if student.flagged_at %}
        <div>First flagged: {{ student.flagged_at.strftime("%Y-%m-%d %H:%M") }}</div>
        {% endif %}
        {% if student.flagged_by %}
        <div>By: {{ student.flagged_by.name }}</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Flag History -->
  {% if student.flag_history_json and student.flag_history_json|length > 0 %}
  <details class="card" style="margin-bottom: 30px;">
    <summary style="cursor: pointer; font-weight: bold; user-select: none;">ğŸ“œ Flag History ({{ student.flag_history_json|length }} entries)</summary>
    <div style="margin-top: 15px;">
      {% for entry in student.flag_history_json|reverse %}
      <div style="padding: 10px; margin-bottom: 10px; background: rgba(99, 127, 190, 0.05); border-radius: 6px; border-left: 3px solid {% if entry.status == 'confirmed' %}#dc2626{% elif entry.status == 'under_review' %}#f59e0b{% elif entry.status == 'cleared' %}#10b981{% else %}#94a3b8{% endif %};">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 500; text-transform: uppercase; color: {% if entry.status == 'confirmed' %}#dc2626{% elif entry.status == 'under_review' %}#f59e0b{% elif entry.status == 'cleared' %}#10b981{% else %}#94a3b8{% endif %};">
            {{ entry.status|replace("_", " ") }}
          </span>
          <small style="color: #64748b;">{{ entry.timestamp[:16] if entry.timestamp else "" }}</small>
        </div>
        {% if entry.notes %}
        <p style="margin: 5px 0 0; color: #94a3b8; font-size: 13px;">{{ entry.notes }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </details>
  {% endif %}

  <!-- Add Manual Warning -->
  <details class="card" style="margin-bottom: 30px;">
    <summary style="cursor: pointer; font-weight: bold; user-select: none;">â• Add Manual Warning</summary>
    <form method="post" action="{{ url_for('warnings_add_manual', student_id=student.id) }}" style="margin-top: 15px;">
      <input type="hidden" name="csrf" value="{{ csrf_token() }}">
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Type:</label>
        <select name="type" style="padding: 8px; width: 100%;">
          <option value="manual">Manual Review</option>
          <option value="plagiarism">Plagiarism</option>
          <option value="collaboration">Unauthorized Collaboration</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Severity:</label>
        <select name="severity" style="padding: 8px; width: 100%;">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description:</label>
        <textarea name="description" rows="3" required 
                  style="padding: 8px; width: 100%; font-family: inherit;"
                  placeholder="Describe the issue..."></textarea>
      </div>

      <button type="submit" class="btn btn-primary">
        Add Warning
      </button>
    </form>
  </details>

  <!-- Warnings List -->
  <div style="margin-bottom: 30px;">
    <h2 style="margin-bottom: 20px;">âš ï¸ Warnings ({{ warnings|length }})</h2>
    
    {% if warnings %}
    <div style="display: grid; gap: 15px;">
      {% for warning in warnings|reverse %}
      <div class="card" style="border-left: 4px solid {% if warning.severity == 'high' %}#637FBE{% elif warning.severity == 'medium' %}#5775B8{% else %}#94a3b8{% endif %};">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
          <div>
            <strong style="font-size: 16px;">{{ warning.type|replace("_", " ")|title }}</strong>
            {% if warning.auto_detected %}
            <span style="background: rgba(99, 127, 190, 0.2); color: #637FBE; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">AUTO</span>
            {% else %}
            <span style="background: rgba(99, 127, 190, 0.1); color: #94a3b8; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">MANUAL</span>
            {% endif %}
          </div>
          <span style="background: {% if warning.severity == 'high' %}rgba(99, 127, 190, 0.2){% elif warning.severity == 'medium' %}rgba(87, 117, 184, 0.2){% else %}rgba(148, 163, 184, 0.2){% endif %}; color: {% if warning.severity == 'high' %}#637FBE{% elif warning.severity == 'medium' %}#5775B8{% else %}#94a3b8{% endif %}; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase;">
            {{ warning.severity }}
          </span>
        </div>
        <p style="margin: 0 0 10px; color: #e5e7eb;">{{ warning.description }}</p>
        
        {# Show context if available #}
        {% if warning.exam_code or warning.project_code %}
        <div style="margin: 10px 0; padding: 8px; background: rgba(99, 127, 190, 0.1); border-radius: 4px;">
          {% if warning.exam_code %}
          <span style="color: #94a3b8;">ğŸ“ Exam: <strong style="color: #e5e7eb;">{{ warning.exam_code }}</strong></span>
          {% elif warning.project_code %}
          <span style="color: #94a3b8;">ğŸ¯ Project: <strong style="color: #e5e7eb;">{{ warning.project_code }}</strong></span>
          {% if warning.task_title %}
          <span style="color: #94a3b8;"> â€¢ Task: <strong style="color: #e5e7eb;">{{ warning.task_title }}</strong></span>
          {% endif %}
          {% endif %}
        </div>
        {% endif %}
        
        <small style="color: #94a3b8;">{{ warning.timestamp[:19] if warning.timestamp else "N/A" }}</small>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="card">
      <p style="margin: 0; color: #94a3b8; text-align: center;">
        No warnings recorded for this student.
      </p>
    </div>
    {% endif %}
  </div>

  <!-- Recent Submissions -->
  <div style="margin-bottom: 30px;">
    <h2 style="margin-bottom: 20px;">ğŸ“ Recent Exam Submissions</h2>
    {% if exam_submissions %}
    <div class="card">
      <table style="width: 100%;">
        <thead>
          <tr>
            <th style="text-align: left;">Exam</th>
            <th style="text-align: center;">Score</th>
            <th style="text-align: center;">Duration</th>
            <th style="text-align: left;">Submitted</th>
          </tr>
        </thead>
        <tbody>
          {% for sub in exam_submissions %}
          <tr>
            <td>{{ sub.exam.title if sub.exam else "N/A" }}</td>
            <td style="text-align: center;">{{ "%.1f"|format(sub.score) }} / {{ "%.1f"|format(sub.max_score) }}</td>
            <td style="text-align: center;">
              {% if sub.started_at and sub.submitted_at %}
              {{ ((sub.submitted_at - sub.started_at).total_seconds() / 60)|round|int }} min
              {% else %}
              N/A
              {% endif %}
            </td>
            <td>{{ sub.submitted_at.strftime("%Y-%m-%d %H:%M") if sub.submitted_at else "N/A" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="card">
      <p style="margin: 0; color: #94a3b8; text-align: center;">
        No exam submissions found.
      </p>
    </div>
    {% endif %}
  </div>

  <!-- Recent Project Task Submissions -->
  <div style="margin-bottom: 30px;">
    <h2 style="margin-bottom: 20px;">ğŸ¯ Recent Project Task Submissions</h2>
    {% if task_submissions %}
    <div class="card">
      <table style="width: 100%;">
        <thead>
          <tr>
            <th style="text-align: left;">Task</th>
            <th style="text-align: center;">Status</th>
            <th style="text-align: center;">Duration</th>
            <th style="text-align: left;">Submitted</th>
          </tr>
        </thead>
        <tbody>
          {% for sub in task_submissions %}
          <tr>
            <td>{{ sub.task.title if sub.task else "N/A" }}</td>
            <td style="text-align: center;">
              <span style="padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; background: rgba(99, 127, 190, 0.15); color: #637FBE;">
                {{ sub.status|replace("_", " ")|title }}
              </span>
            </td>
            <td style="text-align: center;">
              {% if sub.started_at and sub.submitted_at %}
              {{ ((sub.submitted_at - sub.started_at).total_seconds() / 60)|round|int }} min
              {% else %}
              N/A
              {% endif %}
            </td>
            <td>{{ sub.submitted_at.strftime("%Y-%m-%d %H:%M") if sub.submitted_at else "N/A" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="card">
      <p style="margin: 0; color: #94a3b8; text-align: center;">
        No project task submissions found.
      </p>
    </div>
    {% endif %}
  </div>

  <div style="margin-top: 30px;">
    <a href="{{ url_for('warnings_list') }}" style="color: #94a3b8; text-decoration: none;">â† Back to Warnings</a>
  </div>
</div>
{% endblock %}

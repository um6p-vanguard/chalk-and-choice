{% extends "base.html" %}
{% block content %}
<style>
  #admin-notebook-container:fullscreen {
    background: #0f172a;
    padding: 10px;
  }
  #admin-notebook-container:fullscreen iframe {
    border-radius: 8px;
  }
</style>

<h2>Admin Viewer (JupyterLite)</h2>
<p class="muted">Read-only viewer for student notebooks.</p>

<div style="margin:0 0 10px 0;">
  <button id="fullscreenBtn" class="btn" title="Toggle Fullscreen">⛶ Fullscreen</button>
</div>

<div id="admin-notebook-container" style="height:82vh;position:relative;">
  <iframe id="jlite_frame" src="about:blank" style="width:100%;height:100%;border:0"></iframe>
</div>

<script>
(function(){
  const frame = document.getElementById('jlite_frame');
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  async function waitForAppReady(maxMs=60000){
    const win = frame.contentWindow;
    const start = Date.now();
    while (Date.now() - start < maxMs){
      const app = win && win.jupyterapp;
      if (app && app.serviceManager && app.serviceManager.ready){
        try { await app.serviceManager.ready; } catch(_){}
        return app;
      }
      await sleep(100);
    }
    return null;
  }

  async function cleanWorkspace(app){
    const contents = app.serviceManager.contents;
    async function deleteTree(path){
      const model = await contents.get(path || '', {content: true}).catch(()=>null);
      if (!model) return;
      if (model.type === 'directory'){
        for (const child of (model.content || [])){ await deleteTree(child.path); }
        if (path) await contents.delete(path).catch(()=>{});
      } else if (path) {
        await contents.delete(path).catch(()=>{});
      }
    }
    const root = await contents.get('', {content:true}).catch(()=>null);
    if (root && Array.isArray(root.content)){
      for (const item of root.content){ await deleteTree(item.path); }
    }
  }

  function sanitizeName(name){
    let n = (name || 'Notebook').trim().replace(/[\\\/:*?"<>|]/g, '-');
    if (!n.toLowerCase().endsWith('.ipynb')) n += '.ipynb';
    return n;
  }

  async function importAdminNotebook(app, nbId){
    const r = await fetch(`/api/admin/notebooks/${nbId}`, {credentials:"same-origin"});
    if(!r.ok){ alert('Could not load notebook.'); return; }
    const data = await r.json();
    const nb = data.content || {};
    const desired = sanitizeName(data.name || `Notebook-${nbId}.ipynb`);
    await cleanWorkspace(app);
    const contents = app.serviceManager.contents;
    await contents.delete(desired).catch(()=>{});
    await contents.save(desired, {type:"notebook", format:"json", content: nb});
    await app.commands.execute('docmanager:open', { path: desired });
  }

  frame.src = "{{ url_for('static', filename='jlite/lab/index.html') }}";
  frame.addEventListener('load', async () => {
    const app = await waitForAppReady(60000);
    const params = new URLSearchParams(window.location.search);
    const id = parseInt(params.get('import_nb') || '0', 10);
    if (app && id){ await importAdminNotebook(app, id); }
  });

  // ==================== FULLSCREEN FUNCTIONALITY ====================
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const container = document.getElementById('admin-notebook-container');

  function updateFullscreenButton() {
    if (document.fullscreenElement) {
      fullscreenBtn.textContent = '⛶ Exit Fullscreen';
      fullscreenBtn.style.position = 'fixed';
      fullscreenBtn.style.top = '10px';
      fullscreenBtn.style.right = '10px';
      fullscreenBtn.style.zIndex = '10000';
    } else {
      fullscreenBtn.textContent = '⛶ Fullscreen';
      fullscreenBtn.style.position = 'static';
      fullscreenBtn.style.zIndex = 'auto';
    }
  }

  async function toggleFullscreen() {
    try {
      if (!document.fullscreenElement) {
        await container.requestFullscreen();
      } else {
        await document.exitFullscreen();
      }
    } catch (err) {
      console.error('Fullscreen error:', err);
      alert('Fullscreen not supported in your browser');
    }
  }

  fullscreenBtn.addEventListener('click', toggleFullscreen);
  document.addEventListener('fullscreenchange', updateFullscreenButton);
  
  // Keyboard shortcut: F11 or Ctrl+Shift+F
  document.addEventListener('keydown', (e) => {
    if ((e.key === 'F11') || (e.ctrlKey && e.shiftKey && e.key === 'F')) {
      e.preventDefault();
      toggleFullscreen();
    }
  });
})();
</script>
{% endblock %}

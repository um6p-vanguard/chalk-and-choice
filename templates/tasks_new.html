{% extends "base.html" %}
{% block title %}Create Task{% endblock %}
{% block content %}
<div class="wrap" style="max-width: 900px">
  <h2>Create Task</h2>

  <form class="card" method="post" action="{{ url_for('admin_task_create') }}">
    <input type="hidden" name="csrf" value="{{ csrf_token() }}">
    <input type="hidden" name="preview" id="preview-flag" value="0">

    <div class="row">
      <div style="flex:1">
        <label>Quest</label>
        <select name="quest_id" class="{% if errors.get('quest_id') %}text-danger{% endif %}">
          <option value="">— Select —</option>
          {% for q in quests %}
          <option value="{{ q.id }}" {% if quest_id|int == q.id %}selected{% endif %}>{{ q.code }} — {{ q.title }}</option>
          {% endfor %}
        </select>
        {% if errors.get('quest_id') %}<div class="text-danger">{{ errors['quest_id'] }}</div>{% endif %}
      </div>
      <div style="flex:1">
        <label>Type</label>
        <select name="type" class="{% if errors.get('type') %}text-danger{% endif %}">
          <option value="">— Select —</option>
          {% for t in types %}
          <option value="{{ t }}" {% if type_val==t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
        {% if errors.get('type') %}<div class="text-danger">{{ errors['type'] }}</div>{% endif %}
      </div>
    </div>

    <div class="row">
      <div style="flex:1">
        <label>Slug</label>
        <input type="text" name="slug" maxlength="64" value="{{ slug }}">
        {% if errors.get('slug') %}<div class="text-danger">{{ errors['slug'] }}</div>{% endif %}
        <div class="muted">Unique within the quest.</div>
      </div>
      <div style="flex:2">
        <label>Title</label>
        <input type="text" name="title" maxlength="255" value="{{ title }}">
        {% if errors.get('title') %}<div class="text-danger">{{ errors['title'] }}</div>{% endif %}
      </div>
    </div>

    <label>Description</label>
    <textarea name="description" rows="4">{{ description }}</textarea>

    <div class="row">
      <div>
        <label>XP</label>
        <input type="number" name="xp" min="0" value="{{ xp }}">
        {% if errors.get('xp') %}<div class="text-danger">{{ errors['xp'] }}</div>{% endif %}
      </div>
      <div>
        <label>Stars</label>
        <input type="number" name="stars" min="0" value="{{ stars }}">
        {% if errors.get('stars') %}<div class="text-danger">{{ errors['stars'] }}</div>{% endif %}
      </div>
      <div>
        <label>Difficulty (1..5)</label>
        <input type="number" name="difficulty" min="1" max="5" value="{{ difficulty }}">
        {% if errors.get('difficulty') %}<div class="text-danger">{{ errors['difficulty'] }}</div>{% endif %}
      </div>
      <div>
        <label>Order in quest</label>
        <input type="number" name="order_in_quest" min="1" value="{{ order_in_quest }}">
        {% if errors.get('order_in_quest') %}<div class="text-danger">{{ errors['order_in_quest'] }}</div>{% endif %}
      </div>
      <div style="display:flex; align-items:center; gap:8px; margin-top:22px">
        <input type="checkbox" name="must_pass" {% if must_pass %}checked{% endif %}>
        <label>Required to complete quest</label>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Min score to pass (0..1)</label>
        <input type="number" step="0.01" min="0" max="1" name="min_score_to_pass" value="{{ min_score_to_pass }}">
        {% if errors.get('min_score_to_pass') %}<div class="text-danger">{{ errors['min_score_to_pass'] }}</div>{% endif %}
      </div>
    </div>

    <label>Task configuration</label>
    <div class="card" style="padding:12px">
    {% set schema = schemas.get(type_val) %}
    {% if not schema %}
        <div class="muted">Select a <b>Type</b> above to see configuration fields.</div>
    {% else %}
        {% for f in schema.fields %}
        <div class="mb-2">
            <label>{{ f.label }}</label>
            {% if f.type == "text" %}
            <input type="text" name="{{ f.key }}" value="{{ request.form.get(f.key, f.default) }}">
            {% elif f.type == "number" %}
            <input type="number" name="{{ f.key }}" {% if f.min is defined %}min="{{ f.min }}"{% endif %}
                    value="{{ request.form.get(f.key, f.default) }}">
            {% elif f.type == "textarea" %}
            <textarea name="{{ f.key }}" rows="5">{{ request.form.get(f.key, f.default) }}</textarea>
            {% elif f.type == "checkbox" %}
            {% set checked = request.form.get(f.key) == "on" or (request.method != "POST" and f.default) %}
            <input type="checkbox" name="{{ f.key }}" {% if checked %}checked{% endif %}>
            {% elif f.type == "select" %}
            {% set cur = request.form.get(f.key, f.default) %}
            <select name="{{ f.key }}">
                {% for ch in f.choices %}
                <option value="{{ ch }}" {% if ch == cur %}selected{% endif %}>{{ ch }}</option>
                {% endfor %}
            </select>
            {% endif %}
        </div>
        {% endfor %}
    {% endif %}
    {% if errors.get('config') %}<div class="text-danger">{{ errors['config'] }}</div>{% endif %}
    </div>

    <label>Prerequisites (same quest)</label>
    <select name="prereq_task_ids" multiple size="6" {% if not quest_id %}disabled{% endif %}>
      {% for pt in possible_prereqs %}
        <option value="{{ pt.id }}"
          {% if (pt.id|string) in selected_prereqs %}selected{% endif %}>
          [#{{ pt.order_in_quest }}] {{ pt.slug }} — {{ pt.title }}
        </option>
      {% endfor %}
    </select>
    <div class="muted">Hold Ctrl/Cmd to select multiple. Choose a Quest first to load tasks.</div>


    <label>Learning outcomes (optional)</label>
    <select name="lo_ids" multiple size="6">
      {% for lo in los %}
      <option value="{{ lo.id }}" {% if lo.id|string in lo_ids %}selected{% endif %}>
        {{ lo.code }} — {{ lo.title }}
      </option>
      {% endfor %}
    </select>

    <div class="sp"></div>
    <div class="row">
      <button class="btn btn-primary" type="submit">Save</button>
      <a class="btn" href="{{ url_for('admin_task_list') }}">Cancel</a>
    </div>
  </form>
</div>

<script>
(function(){
  const form = document.querySelector('form[action="{{ url_for("admin_task_create") }}"]');
  if (!form) return;
  const preview = form.querySelector('#preview-flag');
  const questSel = form.querySelector('select[name="quest_id"]');
  const typeSel  = form.querySelector('select[name="type"]');

  function submitPreview(){
    preview.value = '1';
    form.submit();
  }
  if (questSel) questSel.addEventListener('change', submitPreview);
  if (typeSel)  typeSel.addEventListener('change', submitPreview);
})();
</script>

{% endblock %}
